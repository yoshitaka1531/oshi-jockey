<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>今日の推しジョッキー</title>

  <!-- 筆文字フォント -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Yuji+Boku&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#171717;
      --paper:#fbf7ee;
      --paper2:#f2ead7;
      --line:#d9cdb5;
      --seal:#b00020;
      --indigo:#1a4aa5;
      --shadow: rgba(0,0,0,.08);
      --card: rgba(255,255,255,.60);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:18px;
      color:var(--ink);
      background:
        radial-gradient(1100px 900px at 15% 10%, rgba(0,0,0,.05), transparent 60%),
        radial-gradient(900px 800px at 85% 0%, rgba(0,0,0,.035), transparent 55%),
        linear-gradient(180deg, var(--paper), var(--paper2));
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
    }
    /* 和紙っぽい質感 */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:
        repeating-linear-gradient(0deg, rgba(0,0,0,.016) 0, rgba(0,0,0,.016) 1px, transparent 1px, transparent 4px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.012) 0, rgba(0,0,0,.012) 1px, transparent 1px, transparent 5px);
      mix-blend-mode:multiply;
      opacity:.32;
    }

    .wrap{max-width:980px;margin:0 auto}

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width:860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    /* おみくじ台（共通カード） */
    .shrine{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.55);
      box-shadow: 0 12px 32px var(--shadow);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .seal{
      position:absolute;
      right:16px;
      top:14px;
      width:64px;height:64px;
      border:2px solid rgba(176,0,32,.65);
      color:rgba(176,0,32,.8);
      border-radius:10px;
      display:grid;
      place-items:center;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:26px;
      transform:rotate(9deg);
      background:rgba(255,255,255,.18);
      user-select:none;
    }

    /* 見出し（カード内） */
    .title{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:34px;
      letter-spacing:.08em;
      margin:0;
      line-height:1.15;
      padding-right:78px; /* 朱印と干渉しない */
    }
    .hint{
      margin:8px 0 0;
      color:#444;
      font-size:12px;
      line-height:1.6;
    }

    .btnrow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:14px;
    }
    .btn{
      border:1px solid #cbbd9f;
      background:linear-gradient(180deg, #fffdf7, #f3ead6);
      color:var(--ink);
      border-radius:14px;
      padding:12px 18px;
      cursor:pointer;
      box-shadow: 0 6px 16px var(--shadow);
      transition: transform .08s ease, box-shadow .08s ease, opacity .08s ease;
      font-size:16px;
    }
    .btn:active{transform:translateY(1px);box-shadow: 0 4px 12px var(--shadow)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn.main{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:22px;
      letter-spacing:.18em;
      padding:14px 22px;
      border-color:#b9a27a;
    }
    .btn.share{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      letter-spacing:.08em;
    }

    /* 推しジョッキー結果（縦書き） */
    .omikuji{
      margin-top:16px;
      display:none;
      border:1px solid var(--line);
      border-radius:18px;
      background:var(--card);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .omikuji::before{
      content:"";
      position:absolute;
      left:16px; right:16px; top:10px;
      height:1px;
      background:linear-gradient(90deg, transparent, rgba(0,0,0,.12), transparent);
      opacity:.75;
    }
    .omikujiInner{
      display:flex;
      gap:16px;
      align-items:stretch;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .vertical{
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:28px;
      letter-spacing:.18em;
      line-height:1.25;
      padding:10px 6px;
      min-height:220px;
      border-right:1px dashed rgba(0,0,0,.12);
    }
    .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      justify-content:flex-start;
      min-width:240px;
      flex:1;
      padding-top:6px;
    }
    .link{
      display:inline-block;
      color:var(--indigo);
      text-decoration:underline;
      text-underline-offset:3px;
      word-break:break-all;
      font-size:15px;
    }
    .small{
      color:#444;
      font-size:12px;
      line-height:1.6;
    }
    .err{
      margin-top:10px;
      white-space:pre-wrap;
      color:var(--seal);
      font-size:13px;
      display:none;
    }

    /* 馬券おみくじ：設定欄 */
    .sectionTitle{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:22px;
      letter-spacing:.10em;
      margin:0 0 10px;
      padding-right:78px; /* 朱印と干渉しない */
    }
    .formRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-top:12px;
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      color:#333;
      min-width:180px;
    }
    select, input{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.82);
      font-size:14px;
      outline:none;
    }
    input{width:140px}

    /* 馬券っぽいカード（強化版 / オリジナル） */
    .ticket{
      margin-top:14px;
      display:none;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.68);
      overflow:hidden;
      box-shadow: 0 10px 26px var(--shadow);
      position:relative;
    }
    /* 馬券風の薄い透かし（蹄鉄風） */
    .ticket::after{
      content:"";
      position:absolute;
      right:-60px; top:-60px;
      width:260px; height:260px;
      border-radius:999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(26,74,165,.10), transparent 62%),
        radial-gradient(circle at 65% 70%, rgba(176,0,32,.08), transparent 60%);
      transform:rotate(10deg);
      pointer-events:none;
    }
    .ticketTop{
      display:grid;
      grid-template-columns: 92px 1fr;
      gap:12px;
      padding:14px;
      border-bottom:1px dashed rgba(0,0,0,.12);
      position:relative;
    }
    /* 左側：QRっぽいブロック（雰囲気） */
    .qrBox{
      border:1px solid rgba(0,0,0,.18);
      border-radius:12px;
      background:rgba(0,0,0,.03);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
      justify-content:center;
    }
    .qr{
      width:64px;height:64px;
      border-radius:10px;
      background:
        linear-gradient(90deg, rgba(0,0,0,.10) 0 1px, transparent 1px 6px),
        linear-gradient(0deg, rgba(0,0,0,.10) 0 1px, transparent 1px 6px);
      background-size:6px 6px;
      opacity:.55;
      border:1px solid rgba(0,0,0,.16);
    }
    .qrSmall{
      width:64px;height:18px;
      border-radius:8px;
      border:1px solid rgba(0,0,0,.16);
      background:rgba(255,255,255,.60);
      font-size:11px;
      display:grid;
      place-items:center;
      color:#333;
    }

    /* 右側：本体 */
    .ticketBody{
      display:flex;
      gap:12px;
      align-items:stretch;
    }
    .ticketType{
      min-width:64px;
      border:1px solid rgba(0,0,0,.18);
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 6px;
      background:rgba(0,0,0,.04);
      font-family:"Yuji Syuku","Yuji Boku",serif;
      letter-spacing:.1em;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size:18px;
    }
    .ticketMain{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-top:2px;
    }
    .ticketLine{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .ticketRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .chip{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.18);
      background:rgba(255,255,255,.78);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing:.08em;
      font-size:14px;
    }
    .mul{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      opacity:.85;
    }
    .ticketHint{
      font-size:12px;
      color:#444;
      line-height:1.6;
    }
    .ticketBottom{
      padding:12px 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      background:rgba(255,255,255,.45);
    }
    .yen{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:14px;
      letter-spacing:.06em;
    }
    .stamp{
      display:inline-grid;
      place-items:center;
      width:54px;height:54px;
      border-radius:10px;
      border:2px solid rgba(176,0,32,.65);
      color:rgba(176,0,32,.8);
      font-family:"Yuji Syuku","Yuji Boku",serif;
      transform:rotate(-8deg);
      background:rgba(255,255,255,.20);
      user-select:none;
    }

    .footer{
      margin-top:14px;
      padding:14px 16px;
      border:1px dashed #cbbd9f;
      border-radius:16px;
      background:rgba(255,255,255,.45);
    }
    .footer h2{
      margin:0 0 8px;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:18px;
      letter-spacing:.08em;
    }
    .footlink{
      color:var(--indigo);
      text-decoration:underline;
      text-underline-offset:3px;
      word-break:break-all;
      font-size:13px;
    }

    @media (max-width:520px){
      .title{font-size:32px}
      .vertical{font-size:24px; min-height:190px;}
      .actions{min-width:unset}
      label{min-width:unset}
      .ticketTop{grid-template-columns: 84px 1fr;}
      .ticketType{min-width:58px;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="grid">

      <!-- ✅ 青枠の部分：タイトル〜ボタン〜結果を「1カード」にまとめる -->
      <div class="shrine">
        <div class="seal">推</div>

        <h1 class="title">今日の推しジョッキー</h1>
        <p class="hint">神社のおみくじ風に、今日の推しを授かります。</p>

        <div class="btnrow">
          <!-- ★IDは維持（壊れないため） -->
          <button id="drawBtn" class="btn main" type="button">勝負！</button>
          <button id="shareBtn" class="btn share" type="button" disabled>シェア</button>
        </div>

        <div class="omikuji" id="result">
          <div class="omikujiInner">
            <div class="vertical" id="name">（表示）</div>

            <div class="actions">
              <a id="profileLink" class="link" href="#" target="_blank" rel="noopener noreferrer">プロフィールを見る</a>
              <div class="small">
                ※リンク先はUMAJOの個別プロフィールです。<br>
                ※開けない場合は時間をおいて再度お試しください。
              </div>

              <!-- 候補数表示は出さない -->
              <div id="meta" style="display:none;"></div>

              <div class="err" id="err"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 馬券おみくじ（A→C→B） -->
      <div class="shrine">
        <div class="seal">券</div>

        <h2 class="sectionTitle">馬券おみくじ</h2>
        <div class="small">種類・頭数・点数・合計金額を選んで、「このレースのオススメ馬券」を引きます（ランダム）。</div>

        <div class="formRow">
          <label>
            勝馬投票券
            <select id="betType">
              <option value="win">単勝</option>
              <option value="place">複勝</option>
              <option value="wakuren">枠連</option>
              <option value="umaren">馬連</option>
              <option value="wide">ワイド</option>
              <option value="umatan">馬単</option>
              <option value="trio">3連複</option>
              <option value="trifecta">3連単</option>
            </select>
          </label>

          <label>
            レース頭数（2〜18）
            <input id="fieldSize" type="number" min="2" max="18" value="12" />
          </label>

          <!-- ✅ A：点数 -->
          <label>
            点数
            <select id="ticketPoints">
              <option value="1">1点</option>
              <option value="3">3点</option>
              <option value="5">5点</option>
            </select>
          </label>

          <!-- ✅ B：合計金額 -->
          <label>
            合計金額（円）
            <input id="budget" type="number" min="100" step="100" value="1000" />
          </label>

          <button id="ticketBtn" class="btn main" type="button">馬券おみくじ</button>
        </div>

        <!-- ✅ 馬券表示：馬券感UP -->
        <div class="ticket" id="ticket">
          <div class="ticketTop">
            <div class="qrBox">
              <div class="qr"></div>
              <div class="qrSmall" id="raceInfo">R / N</div>
            </div>

            <div class="ticketBody">
              <div class="ticketType" id="ticketTypeLabel">単勝</div>

              <div class="ticketMain">
                <div class="ticketLine" id="ticketLines">
                  <!-- JSで行を生成 -->
                </div>

                <div class="ticketHint" id="ticketHint">
                  ※本機能はランダム生成です。実際の購入判断はご自身の責任でお願いいたします。
                </div>

                <a id="ticketShareLink" class="link" href="#" style="display:none;">この馬券をシェア</a>
              </div>
            </div>
          </div>

          <div class="ticketBottom">
            <div class="yen" id="ticketAmount">合計：1000円</div>
            <div class="stamp" id="ticketFortune">吉</div>
          </div>
        </div>

        <div class="err" id="ticketErr"></div>
      </div>

    </div>

    <!-- おすすめサイト（最下部） -->
    <div class="footer">
      <h2>おすすめサイト</h2>
      <a class="footlink"
         href="https://c-lemaire.co.jp/?srsltid=AfmBOop6TBukVoj2Y2Cs9SYRuY_8TsMUwtuXH3sUJPnIAXSxN-VKYrgq"
         target="_blank" rel="noopener noreferrer">
        https://c-lemaire.co.jp/
      </a>
    </div>
  </div>

  <script>
    // ====== 既存：ジョッキーおみくじ（壊さない） ======
    const drawBtn  = document.getElementById("drawBtn");
    const shareBtn = document.getElementById("shareBtn");
    const resultEl = document.getElementById("result");
    const nameEl   = document.getElementById("name");
    const linkEl   = document.getElementById("profileLink");
    const errEl    = document.getElementById("err");

    let lastPicked = null;
    let lastTicket = null;

    function setShareEnabled(){
      // どちらかの結果があればシェア可能
      shareBtn.disabled = !(lastPicked || lastTicket);
    }

    function showError(msg){
      resultEl.style.display = "block";
      errEl.style.display = "block";
      errEl.textContent = msg;
    }
    function clearError(){
      errEl.style.display = "none";
      errEl.textContent = "";
    }

    async function draw(){
      drawBtn.disabled = true;
      drawBtn.textContent = "神託中…";
      clearError();

      try{
        const res = await fetch("/api/oshi-jockey", { cache: "no-store" });
        const text = await res.text();
        let data;
        try{ data = JSON.parse(text); }
        catch{ throw new Error("APIの応答がJSONではありませんでした。時間をおいて再度お試しください。"); }

        if(!res.ok || data.error){
          throw new Error(data.message || `API error: ${res.status}`);
        }

        const picked = data.picked || {};
        const name = picked.name || "(ジョッキー)";
        const profileUrl = picked.profileUrl;
        if(!profileUrl) throw new Error("APIの返却に profileUrl がありません。");

        lastPicked = { name, profileUrl };
        nameEl.textContent = name;

        linkEl.href = profileUrl;
        linkEl.target = "_blank";
        linkEl.rel = "noopener noreferrer";

        resultEl.style.display = "block";
        setShareEnabled();

      }catch(e){
        console.error(e);
        lastPicked = null;
        setShareEnabled();
        showError("取得に失敗しました。\n\n" + String(e.message || e));
      }finally{
        drawBtn.disabled = false;
        drawBtn.textContent = "勝負！";
      }
    }

    function buildShareText(){
      const parts = [];
      let url = location.href;

      if(lastPicked){
        parts.push(`今日の推しジョッキーは「${lastPicked.name}」！`);
        url = lastPicked.profileUrl || url;
      }
      if(lastTicket){
        parts.push(`馬券おみくじ：${lastTicket.typeLabel} / ${lastTicket.linesText}（合計${lastTicket.total}円）`);
        // URLはジョッキーURL優先。なければサイトURL。
      }

      return { text: parts.join("\n"), url };
    }

    async function share(){
      if(!(lastPicked || lastTicket)) return;

      const { text, url } = buildShareText();

      if(navigator.share){
        try{
          await navigator.share({ title:"今日の推しジョッキー", text, url });
          return;
        }catch(_){}
      }
      const xUrl = `https://x.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
      window.open(xUrl, "_blank", "noopener,noreferrer");
    }

    drawBtn.addEventListener("click", draw);
    shareBtn.addEventListener("click", share);

    // ====== 馬券おみくじ（A→C→B） ======
    const betTypeEl = document.getElementById("betType");
    const fieldSizeEl = document.getElementById("fieldSize");
    const ticketBtn = document.getElementById("ticketBtn");
    const pointsEl = document.getElementById("ticketPoints");
    const budgetEl = document.getElementById("budget");

    const ticketEl = document.getElementById("ticket");
    const ticketTypeLabelEl = document.getElementById("ticketTypeLabel");
    const ticketLinesEl = document.getElementById("ticketLines");
    const ticketAmountEl = document.getElementById("ticketAmount");
    const ticketHintEl = document.getElementById("ticketHint");
    const ticketErrEl = document.getElementById("ticketErr");
    const raceInfoEl = document.getElementById("raceInfo");
    const ticketFortuneEl = document.getElementById("ticketFortune");
    const ticketShareLinkEl = document.getElementById("ticketShareLink");

    const typeLabels = {
      win: "単勝",
      place: "複勝",
      wakuren: "枠連",
      umaren: "馬連",
      wide: "ワイド",
      umatan: "馬単",
      trio: "3連複",
      trifecta: "3連単",
    };

    function randInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function sampleUniqueNumbers(count, min, max){
      const set = new Set();
      while(set.size < count){
        set.add(randInt(min, max));
      }
      return [...set];
    }
    function sortAsc(arr){ return [...arr].sort((a,b)=>a-b); }

    // 枠（1〜8）に馬番（1〜N）を割り当て（雰囲気用）
    function frameOfHorse(horseNo, fieldSize){
      const frames = 8;
      const idx = Math.floor((horseNo - 1) * frames / fieldSize) + 1;
      return Math.min(frames, Math.max(1, idx));
    }

    function buildPick(type, fieldSize){
      if(type === "win"){
        const a = randInt(1, fieldSize);
        return { display: `馬番 ${a}`, hint: "単勝：1頭" };
      }
      if(type === "place"){
        const a = randInt(1, fieldSize);
        return { display: `馬番 ${a}`, hint: "複勝：1頭" };
      }
      if(type === "umaren"){
        const [a,b] = sortAsc(sampleUniqueNumbers(2, 1, fieldSize));
        return { display: `馬番 ${a} - ${b}`, hint: "馬連：2頭（順不同）" };
      }
      if(type === "wide"){
        const [a,b] = sortAsc(sampleUniqueNumbers(2, 1, fieldSize));
        return { display: `馬番 ${a} - ${b}`, hint: "ワイド：2頭（順不同）" };
      }
      if(type === "umatan"){
        const [a,b] = sampleUniqueNumbers(2, 1, fieldSize);
        return { display: `馬番 ${a} → ${b}`, hint: "馬単：2頭（順序あり）" };
      }
      if(type === "trio"){
        const [a,b,c] = sortAsc(sampleUniqueNumbers(3, 1, fieldSize));
        return { display: `馬番 ${a} - ${b} - ${c}`, hint: "3連複：3頭（順不同）" };
      }
      if(type === "trifecta"){
        const [a,b,c] = sampleUniqueNumbers(3, 1, fieldSize);
        return { display: `馬番 ${a} → ${b} → ${c}`, hint: "3連単：3頭（順序あり）" };
      }
      if(type === "wakuren"){
        const [h1,h2] = sortAsc(sampleUniqueNumbers(2, 1, fieldSize));
        const f1 = frameOfHorse(h1, fieldSize);
        const f2 = frameOfHorse(h2, fieldSize);
        const [a,b] = sortAsc([f1,f2]);
        return { display: `枠 ${a} - ${b}`, hint: "枠連：2枠（順不同）" };
      }
      return { display: "-", hint: "" };
    }

    function normalizePick(type, display){
      // 重複チェック用の正規化
      // 順不同系はそのまま、順序系はdisplayそのまま
      return `${type}:${display}`.replace(/\s+/g,"").trim();
    }

    function showTicketError(msg){
      ticketErrEl.style.display = "block";
      ticketErrEl.textContent = msg;
    }
    function clearTicketError(){
      ticketErrEl.style.display = "none";
      ticketErrEl.textContent = "";
    }

    function updatePointsOptions(){
      const type = betTypeEl.value;

      // 単勝/複勝は1点固定
      const fixed1 = (type === "win" || type === "place");
      const allow5 = !(type === "win" || type === "place") ; // 基本OK
      const allow3 = true;

      const current = pointsEl.value;

      pointsEl.innerHTML = "";
      pointsEl.appendChild(new Option("1点", "1"));
      if(!fixed1 && allow3) pointsEl.appendChild(new Option("3点", "3"));
      if(!fixed1 && allow5) pointsEl.appendChild(new Option("5点", "5"));

      // 以前の選択を可能なら維持
      const values = [...pointsEl.options].map(o=>o.value);
      pointsEl.value = values.includes(current) ? current : "1";

      // fixed1なら選択不可（見た目上のミス防止）
      pointsEl.disabled = fixed1;
    }

    function splitBudget(total, points){
      // 100円単位で均等配分（余りは先頭から）
      const base = Math.floor(total / points / 100) * 100;
      let used = base * points;
      let rem = total - used;

      const arr = new Array(points).fill(base);
      let i = 0;
      while(rem >= 100 && i < arr.length){
        arr[i] += 100;
        rem -= 100;
        i++;
      }
      // 端数が出たら最後に足す（見た目優先）
      if(rem > 0) arr[arr.length - 1] += rem;

      return arr;
    }

    function fortuneByTotal(total){
      // 完全ランダムでもよいですが、軽く雰囲気を出します
      const pool = ["大吉","中吉","吉","小吉","末吉"];
      // 1000円以上だと少し上振れしやすい程度
      const bias = total >= 1000 ? ["大吉","中吉"] : [];
      const pick = pool.concat(bias);
      return pick[randInt(0, pick.length - 1)];
    }

    function drawTicket(){
      clearTicketError();

      const type = betTypeEl.value;
      const fieldSize = Number(fieldSizeEl.value);
      const points = Number(pointsEl.value || "1");
      const budget = Number(budgetEl.value);

      if(!Number.isFinite(fieldSize) || fieldSize < 2 || fieldSize > 18){
        showTicketError("レース頭数は 2〜18 の範囲で入力してください。");
        return;
      }
      if(!Number.isFinite(budget) || budget < 100){
        showTicketError("合計金額は 100円以上で入力してください。");
        return;
      }

      // 点数の整合（単勝/複勝は1点固定）
      const fixed1 = (type === "win" || type === "place");
      const finalPoints = fixed1 ? 1 : points;

      // 重複しないように複数点を生成
      const set = new Set();
      const picks = [];
      const maxTry = 50;

      for(let t=0; t<maxTry && picks.length < finalPoints; t++){
        const { display, hint } = buildPick(type, fieldSize);
        const key = normalizePick(type, display);
        if(set.has(key)) continue;
        set.add(key);
        picks.push({ display, hint });
      }
      if(picks.length < finalPoints){
        showTicketError("買い目の生成に失敗しました。時間をおいて再度お試しください。");
        return;
      }

      // 金額配分（B）
      const alloc = splitBudget(budget, finalPoints);

      // 表示反映
      ticketTypeLabelEl.textContent = typeLabels[type] || "馬券";
      raceInfoEl.textContent = `${randInt(1,12)}R / ${fieldSize}頭`; // 雰囲気

      ticketLinesEl.innerHTML = "";
      picks.forEach((p, i)=>{
        const row = document.createElement("div");
        row.className = "ticketRow";

        const chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = p.display;

        const mul = document.createElement("span");
        mul.className = "mul";
        mul.textContent = `× ${alloc[i]}円`;

        row.appendChild(chip);
        row.appendChild(mul);
        ticketLinesEl.appendChild(row);
      });

      const hint = picks[0]?.hint || "";
      ticketHintEl.textContent = `※${hint} / 頭数 ${fieldSize} / ${finalPoints}点（ランダム生成）`;
      ticketAmountEl.textContent = `合計：${budget}円`;
      ticketFortuneEl.textContent = fortuneByTotal(budget);

      ticketEl.style.display = "block";

      // シェア用に保持（C）
      const linesText = picks.map((p,i)=>`${p.display}×${alloc[i]}円`).join(" / ");
      lastTicket = {
        typeLabel: typeLabels[type] || "馬券",
        linesText,
        total: budget,
      };
      setShareEnabled();

      // “この馬券をシェア”リンク（補助）
      ticketShareLinkEl.style.display = "inline-block";
      ticketShareLinkEl.onclick = (e)=>{
        e.preventDefault();
        share();
      };
    }

    betTypeEl.addEventListener("change", updatePointsOptions);
    updatePointsOptions();

    ticketBtn.addEventListener("click", drawTicket);

    // 初期状態：シェア不可
    setShareEnabled();
  </script>
</body>
</html>      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border:1px solid #cbbd9f;
      background:linear-gradient(180deg, #fffdf7, #f3ead6);
      color:var(--ink);
      border-radius:14px;
      padding:12px 18px;
      cursor:pointer;
      box-shadow: 0 6px 16px var(--shadow);
      transition: transform .08s ease, box-shadow .08s ease, opacity .08s ease;
      font-size:16px;
    }
    .btn:active{transform:translateY(1px);box-shadow: 0 4px 12px var(--shadow)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn.main{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:22px;
      letter-spacing:.18em;
      padding:14px 22px;
      border-color:#b9a27a;
    }
    .btn.share{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      letter-spacing:.08em;
    }

    /* 結果（縦書き） */
    .omikuji{
      margin-top:16px;
      display:none;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.62);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .omikuji::before{
      content:"";
      position:absolute;
      left:16px; right:16px; top:10px;
      height:1px;
      background:linear-gradient(90deg, transparent, rgba(0,0,0,.12), transparent);
      opacity:.75;
    }
    .omikujiInner{
      display:flex;
      gap:16px;
      align-items:stretch;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .vertical{
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:28px;
      letter-spacing:.18em;
      line-height:1.25;
      padding:10px 6px;
      min-height:220px;
      border-right:1px dashed rgba(0,0,0,.12);
    }
    .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      justify-content:flex-start;
      min-width:240px;
      flex:1;
      padding-top:6px;
    }
    .link{
      display:inline-block;
      color:var(--indigo);
      text-decoration:underline;
      text-underline-offset:3px;
      word-break:break-all;
      font-size:15px;
    }
    .small{
      color:#444;
      font-size:12px;
      line-height:1.6;
    }
    .err{
      margin-top:10px;
      white-space:pre-wrap;
      color:var(--seal);
      font-size:13px;
      display:none;
    }

    /* 馬券おみくじ：設定欄 */
    .sectionTitle{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:22px;
      letter-spacing:.10em;
      margin:0 0 10px;
    }
    .formRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-top:10px;
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      color:#333;
      min-width:180px;
    }
    select, input{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.8);
      font-size:14px;
      outline:none;
    }
    input{width:140px}

    /* 馬券っぽいカード（オリジナルデザイン） */
    .ticket{
      margin-top:14px;
      display:none;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.65);
      overflow:hidden;
      box-shadow: 0 10px 26px var(--shadow);
    }
    .ticketTop{
      display:flex;
      gap:12px;
      align-items:stretch;
      padding:14px;
      border-bottom:1px dashed rgba(0,0,0,.12);
      position:relative;
    }
    .ticketTop::after{
      content:"";
      position:absolute;
      right:-60px; top:-80px;
      width:220px; height:220px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(26,74,165,.12), transparent 60%);
      transform:rotate(12deg);
      pointer-events:none;
    }
    .ticketType{
      min-width:66px;
      border:1px solid rgba(0,0,0,.18);
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 6px;
      background:rgba(0,0,0,.04);
      font-family:"Yuji Syuku","Yuji Boku",serif;
      letter-spacing:.1em;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size:18px;
    }
    .ticketBody{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .ticketLine{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .chip{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.18);
      background:rgba(255,255,255,.75);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing:.08em;
      font-size:14px;
    }
    .ticketHint{
      font-size:12px;
      color:#444;
      line-height:1.6;
    }
    .ticketBottom{
      padding:12px 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .yen{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:14px;
      letter-spacing:.06em;
    }
    .stamp{
      display:inline-grid;
      place-items:center;
      width:54px;height:54px;
      border-radius:10px;
      border:2px solid rgba(176,0,32,.65);
      color:rgba(176,0,32,.8);
      font-family:"Yuji Syuku","Yuji Boku",serif;
      transform:rotate(-8deg);
      background:rgba(255,255,255,.20);
      user-select:none;
    }

    .footer{
      margin-top:14px;
      padding:14px 16px;
      border:1px dashed #cbbd9f;
      border-radius:16px;
      background:rgba(255,255,255,.45);
    }
    .footer h2{
      margin:0 0 8px;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:18px;
      letter-spacing:.08em;
    }
    .footlink{
      color:var(--indigo);
      text-decoration:underline;
      text-underline-offset:3px;
      word-break:break-all;
      font-size:13px;
    }

    @media (max-width:520px){
      .title{font-size:34px}
      .vertical{font-size:24px; min-height:190px;}
      .actions{min-width:unset}
      label{min-width:unset}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 class="title">今日の推しジョッキー</h1>
        <p class="hint">神社のおみくじ風に、今日の推しを授かります。</p>
      </div>
    </div>

    <div class="grid">
      <!-- ジョッキーおみくじ -->
      <div class="shrine">
        <div class="seal">推</div>

        <div class="btnrow">
          <!-- ★IDは維持（壊れないため） -->
          <button id="drawBtn" class="btn main" type="button">勝負！</button>
          <button id="shareBtn" class="btn share" type="button" disabled>シェア</button>
        </div>

        <div class="omikuji" id="result">
          <div class="omikujiInner">
            <div class="vertical" id="name">（表示）</div>

            <div class="actions">
              <a id="profileLink" class="link" href="#" target="_blank" rel="noopener noreferrer">プロフィールを見る</a>
              <div class="small">
                ※リンク先はUMAJOの個別プロフィールです。<br>
                ※開けない場合は時間をおいて再度お試しください。
              </div>

              <!-- 候補数表示は出さない -->
              <div id="meta" style="display:none;"></div>

              <div class="err" id="err"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 馬券おみくじ -->
      <div class="shrine">
        <div class="seal">券</div>

        <h2 class="sectionTitle">馬券おみくじ</h2>
        <div class="small">勝馬投票券の種類と頭数を選んで、「このレースのオススメ馬券」を引きます（ランダム）。</div>

        <div class="formRow">
          <label>
            勝馬投票券
            <select id="betType">
              <option value="win">単勝</option>
              <option value="place">複勝</option>
              <option value="wakuren">枠連</option>
              <option value="umaren">馬連</option>
              <option value="wide">ワイド</option>
              <option value="umatan">馬単</option>
              <option value="trio">3連複</option>
              <option value="trifecta">3連単</option>
            </select>
          </label>

          <label>
            レース頭数（2〜18）
            <input id="fieldSize" type="number" min="2" max="18" value="12" />
          </label>

          <button id="ticketBtn" class="btn main" type="button">馬券おみくじ</button>
        </div>

        <div class="ticket" id="ticket">
          <div class="ticketTop">
            <div class="ticketType" id="ticketTypeLabel">単勝</div>
            <div class="ticketBody">
              <div class="ticketLine">
                <span class="chip" id="ticketPick">-</span>
              </div>
              <div class="ticketHint" id="ticketHint">
                ※本機能はランダム生成です。実際の購入判断はご自身の責任でお願いいたします。
              </div>
            </div>
          </div>
          <div class="ticketBottom">
            <div class="yen" id="ticketAmount">購入目安：100円</div>
            <div class="stamp">吉</div>
          </div>
        </div>

        <div class="err" id="ticketErr"></div>
      </div>
    </div>

    <!-- おすすめサイト（最下部） -->
    <div class="footer">
      <h2>おすすめサイト</h2>
      <a class="footlink"
         href="https://c-lemaire.co.jp/?srsltid=AfmBOop6TBukVoj2Y2Cs9SYRuY_8TsMUwtuXH3sUJPnIAXSxN-VKYrgq"
         target="_blank" rel="noopener noreferrer">
        https://c-lemaire.co.jp/
      </a>
    </div>
  </div>

  <script>
    // ====== 既存：ジョッキーおみくじ（壊さない） ======
    const drawBtn  = document.getElementById("drawBtn");
    const shareBtn = document.getElementById("shareBtn");
    const resultEl = document.getElementById("result");
    const nameEl   = document.getElementById("name");
    const linkEl   = document.getElementById("profileLink");
    const errEl    = document.getElementById("err");

    let lastPicked = null;

    function showError(msg){
      resultEl.style.display = "block";
      errEl.style.display = "block";
      errEl.textContent = msg;
    }
    function clearError(){
      errEl.style.display = "none";
      errEl.textContent = "";
    }

    async function draw(){
      drawBtn.disabled = true;
      shareBtn.disabled = true;
      drawBtn.textContent = "神託中…";
      clearError();

      try{
        const res = await fetch("/api/oshi-jockey", { cache: "no-store" });
        const text = await res.text();
        let data;
        try{ data = JSON.parse(text); }
        catch{ throw new Error("APIの応答がJSONではありませんでした。時間をおいて再度お試しください。"); }

        if(!res.ok || data.error){
          throw new Error(data.message || `API error: ${res.status}`);
        }

        const picked = data.picked || {};
        const name = picked.name || "(ジョッキー)";
        const profileUrl = picked.profileUrl;
        if(!profileUrl) throw new Error("APIの返却に profileUrl がありません。");

        lastPicked = { name, profileUrl };
        nameEl.textContent = name;

        linkEl.href = profileUrl;
        linkEl.target = "_blank";
        linkEl.rel = "noopener noreferrer";

        resultEl.style.display = "block";
        shareBtn.disabled = false;

      }catch(e){
        console.error(e);
        lastPicked = null;
        showError("取得に失敗しました。\n\n" + String(e.message || e));
      }finally{
        drawBtn.disabled = false;
        drawBtn.textContent = "勝負！";
      }
    }

    async function share(){
      if(!lastPicked) return;

      const text = `今日の推しジョッキーは「${lastPicked.name}」！`;
      const url  = lastPicked.profileUrl;

      if(navigator.share){
        try{
          await navigator.share({ title:"今日の推しジョッキー", text, url });
          return;
        }catch(_){}
      }
      const xUrl = `https://x.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
      window.open(xUrl, "_blank", "noopener,noreferrer");
    }

    drawBtn.addEventListener("click", draw);
    shareBtn.addEventListener("click", share);

    // ====== 新規：馬券おみくじ（フロントのみ・安全） ======
    const betTypeEl = document.getElementById("betType");
    const fieldSizeEl = document.getElementById("fieldSize");
    const ticketBtn = document.getElementById("ticketBtn");

    const ticketEl = document.getElementById("ticket");
    const ticketTypeLabelEl = document.getElementById("ticketTypeLabel");
    const ticketPickEl = document.getElementById("ticketPick");
    const ticketAmountEl = document.getElementById("ticketAmount");
    const ticketHintEl = document.getElementById("ticketHint");
    const ticketErrEl = document.getElementById("ticketErr");

    const typeLabels = {
      win: "単勝",
      place: "複勝",
      wakuren: "枠連",
      umaren: "馬連",
      wide: "ワイド",
      umatan: "馬単",
      trio: "3連複",
      trifecta: "3連単",
    };

    function randInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function sampleUniqueNumbers(count, min, max){
      const set = new Set();
      while(set.size < count){
        set.add(randInt(min, max));
      }
      return [...set];
    }
    function sortAsc(arr){ return [...arr].sort((a,b)=>a-b); }

    // 枠（1〜8）に馬番（1〜N）をざっくり割り当て（均等寄せ）
    function frameOfHorse(horseNo, fieldSize){
      // 1..8 に丸める。頭数が少なくても枠は最大8扱い（雰囲気重視）
      const frames = 8;
      const idx = Math.floor((horseNo - 1) * frames / fieldSize) + 1;
      return Math.min(frames, Math.max(1, idx));
    }

    function buildPick(type, fieldSize){
      // 返り値：{ display: "…", hint: "…" }
      if(type === "win"){
        const a = randInt(1, fieldSize);
        return { display: `馬番 ${a}`, hint: "単勝：1頭" };
      }
      if(type === "place"){
        const a = randInt(1, fieldSize);
        return { display: `馬番 ${a}`, hint: "複勝：1頭" };
      }
      if(type === "umaren"){
        const [a,b] = sortAsc(sampleUniqueNumbers(2, 1, fieldSize));
        return { display: `馬番 ${a} - ${b}`, hint: "馬連：2頭（順不同）" };
      }
      if(type === "wide"){
        const [a,b] = sortAsc(sampleUniqueNumbers(2, 1, fieldSize));
        return { display: `馬番 ${a} - ${b}`, hint: "ワイド：2頭（順不同）" };
      }
      if(type === "umatan"){
        const [a,b] = sampleUniqueNumbers(2, 1, fieldSize);
        return { display: `馬番 ${a} → ${b}`, hint: "馬単：2頭（順序あり）" };
      }
      if(type === "trio"){
        const [a,b,c] = sortAsc(sampleUniqueNumbers(3, 1, fieldSize));
        return { display: `馬番 ${a} - ${b} - ${c}`, hint: "3連複：3頭（順不同）" };
      }
      if(type === "trifecta"){
        const [a,b,c] = sampleUniqueNumbers(3, 1, fieldSize);
        return { display: `馬番 ${a} → ${b} → ${c}`, hint: "3連単：3頭（順序あり）" };
      }
      if(type === "wakuren"){
        // 枠連：枠番号(1..8)を2つ（順不同）
        const [h1,h2] = sortAsc(sampleUniqueNumbers(2, 1, fieldSize));
        const f1 = frameOfHorse(h1, fieldSize);
        const f2 = frameOfHorse(h2, fieldSize);
        const [a,b] = sortAsc([f1,f2]);
        return { display: `枠 ${a} - ${b}`, hint: "枠連：2枠（順不同）" };
      }
      return { display: "-", hint: "" };
    }

    function pickAmount(type){
      // 目安：100円〜1000円（雰囲気）
      const base = [100, 200, 300, 500, 1000];
      // 連単系は少し高めが出やすい、くらいの重み
      const heavy = (type === "umatan" || type === "trifecta") ? [500, 1000, 1000] : [];
      const pool = base.concat(heavy);
      return pool[randInt(0, pool.length - 1)];
    }

    function showTicketError(msg){
      ticketErrEl.style.display = "block";
      ticketErrEl.textContent = msg;
    }
    function clearTicketError(){
      ticketErrEl.style.display = "none";
      ticketErrEl.textContent = "";
    }

    function drawTicket(){
      clearTicketError();

      const type = betTypeEl.value;
      const fieldSize = Number(fieldSizeEl.value);

      if(!Number.isFinite(fieldSize) || fieldSize < 2 || fieldSize > 18){
        showTicketError("レース頭数は 2〜18 の範囲で入力してください。");
        return;
      }

      const { display, hint } = buildPick(type, fieldSize);
      const amount = pickAmount(type);

      ticketTypeLabelEl.textContent = typeLabels[type] || "馬券";
      ticketPickEl.textContent = display;
      ticketAmountEl.textContent = `購入目安：${amount}円`;
      ticketHintEl.textContent = `※${hint} / 頭数 ${fieldSize}（ランダム生成）`;

      ticketEl.style.display = "block";
    }

    ticketBtn.addEventListener("click", drawTicket);
  </script>
</body>
</html>
