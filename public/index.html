<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>今日の推しジョッキー｜神社のおみくじ風</title>

  <!-- AdSense（審査中でも入れてOK。表示されないことがあります） -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4459781035513186"
    crossorigin="anonymous"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kaisei+Tokumin:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --paper:#f7f1e6;
      --paper2:#efe6d7;
      --ink:#1b1b1b;
      --muted:#6b6b6b;
      --line:#cdb99c;
      --stamp:#b84a5a;
      --link:#2b5aa6;
      --shadow: 0 12px 30px rgba(0,0,0,.12);
      --radius: 22px;
      --radius2: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      color:var(--ink);
      font-family: "Shippori Mincho", serif;
      background:
        radial-gradient(1200px 600px at 50% -100px, rgba(255,255,255,.7), rgba(255,255,255,0)),
        linear-gradient(180deg, #eee5d6 0%, #f6f0e6 35%, #efe5d6 100%);
    }
    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 18px 14px 60px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.62));
      border: 1px solid rgba(205,185,156,.55);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 16px;
      position: relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(8px 8px at 20% 30%, rgba(0,0,0,.05), transparent 60%),
        radial-gradient(10px 10px at 70% 40%, rgba(0,0,0,.04), transparent 60%),
        radial-gradient(7px 7px at 50% 70%, rgba(0,0,0,.03), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.50), rgba(255,255,255,.15));
      opacity:.55;
      pointer-events:none;
    }
    .card > *{ position:relative; }

    .title{
      font-family: "Kaisei Tokumin", serif;
      font-weight: 700;
      font-size: 34px;
      letter-spacing: .06em;
      margin: 6px 0 8px;
    }
    .subtitle{
      color: var(--muted);
      margin: 0 0 14px;
      line-height: 1.7;
      font-size: 15px;
    }
    .row{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items:center;
    }
    .btn{
      appearance:none;
      border: 1px solid rgba(205,185,156,.9);
      background: linear-gradient(180deg, #fff8ec, #f2e6d2);
      color: var(--ink);
      border-radius: 14px;
      padding: 14px 18px;
      font-size: 18px;
      cursor:pointer;
      font-family: "Kaisei Tokumin", serif;
      font-weight:700;
      letter-spacing:.08em;
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ font-weight: 700; opacity: .88; }

    .stamp{
      position:absolute;
      right: 14px;
      top: 14px;
      width: 74px;
      height: 74px;
      border: 3px solid rgba(184,74,90,.80);
      color: rgba(184,74,90,.88);
      border-radius: 10px;
      transform: rotate(12deg);
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: "Kaisei Tokumin", serif;
      font-weight: 800;
      letter-spacing: .1em;
      font-size: 28px;
      background: rgba(255,255,255,.35);
    }

    .divider{ height: 10px; }

    .sectionHead{
      font-family: "Kaisei Tokumin", serif;
      font-weight: 800;
      font-size: 28px;
      letter-spacing: .08em;
      margin: 4px 0 8px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width:720px){
      .grid2{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    select, input{
      width:100%;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid rgba(205,185,156,.9);
      background: rgba(255,255,255,.75);
      font-size: 18px;
      font-family: "Shippori Mincho", serif;
      outline:none;
    }

    .resultBox{
      margin-top: 14px;
      padding: 16px 14px;
      border-radius: var(--radius2);
      border: 1px solid rgba(205,185,156,.65);
      background: rgba(255,255,255,.55);
    }

    .pickedName{
      font-family: "Kaisei Tokumin", serif;
      font-weight: 800;
      font-size: 26px;
      margin: 0 0 6px;
      letter-spacing: .08em;
    }

    a{ color: var(--link); }
    .linkBtn{
      display:inline-block;
      margin-top: 4px;
      font-size: 18px;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .smallNote{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.7;
      margin-top: 10px;
    }

    .ticketWrap{
      margin-top: 14px;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(205,185,156,.65);
      background: rgba(255,255,255,.60);
    }
    .ticketWrap svg{
      display:block;
      width: 100%;
      height: auto;
    }

    .belowRow{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .sumText{
      font-family: "Kaisei Tokumin", serif;
      font-weight: 800;
      font-size: 22px;
      letter-spacing: .06em;
    }

    .omikujiStamp{
      width: 86px;
      height: 86px;
      border: 3px solid rgba(184,74,90,.78);
      border-radius: 12px;
      color: rgba(184,74,90,.88);
      transform: rotate(10deg);
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: "Kaisei Tokumin", serif;
      font-weight: 900;
      letter-spacing: .12em;
      background: rgba(255,255,255,.35);
      font-size: 24px;
    }

    .shareLine{
      margin-top: 14px;
      font-size: 18px;
      text-decoration: underline;
      text-underline-offset: 3px;
      cursor:pointer;
      display:inline-block;
    }

    .adsCard{
      margin-top: 14px;
      padding: 14px 14px;
      border-radius: var(--radius2);
      border: 1px dashed rgba(205,185,156,.85);
      background: rgba(255,255,255,.45);
    }

    .adsTitle{
      font-family:"Kaisei Tokumin", serif;
      font-weight:900;
      font-size: 20px;
      margin: 0 0 8px;
      letter-spacing: .06em;
    }
    .adsItem{
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(205,185,156,.55);
      background: rgba(255,255,255,.55);
      margin-top: 10px;
    }
    .adsItem .name{
      font-weight: 800;
      font-size: 16px;
      margin-bottom: 4px;
      font-family:"Kaisei Tokumin", serif;
      letter-spacing:.04em;
    }
    .adsItem .desc{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
      margin-bottom: 6px;
    }

    .error{
      color:#b00020;
      font-size: 13px;
      margin-top: 8px;
      white-space: pre-wrap;
    }

    /* AdSense枠（見た目だけの枠。審査中は広告が出ないこともある） */
    .adSlot{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px dashed rgba(205,185,156,.95);
      background: rgba(255,255,255,.35);
    }
    .adSlotHead{
      font-family:"Kaisei Tokumin", serif;
      font-weight:900;
      letter-spacing:.06em;
      margin: 0 0 8px;
    }
    .adNote{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.7;
      margin-top: 8px;
    }

    /* Policy */
    details.policy{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(205,185,156,.65);
      background: rgba(255,255,255,.45);
      overflow:hidden;
    }
    details.policy summary{
      cursor:pointer;
      padding: 12px 12px;
      font-family:"Kaisei Tokumin", serif;
      font-weight:900;
      letter-spacing:.06em;
      list-style:none;
    }
    details.policy summary::-webkit-details-marker{ display:none; }
    .policyBody{
      padding: 0 12px 12px;
      color: var(--ink);
      line-height: 1.8;
      font-size: 14px;
    }
    .policyBody h3{
      font-family:"Kaisei Tokumin", serif;
      font-size: 16px;
      margin: 10px 0 6px;
    }
    .policyBody ul{ margin: 6px 0 6px 18px; }
    .policyLinks{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .miniBtn{
      display:inline-block;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(205,185,156,.9);
      background: rgba(255,255,255,.55);
      color: var(--ink);
      text-decoration:none;
      font-family:"Kaisei Tokumin", serif;
      font-weight:800;
      letter-spacing:.04em;
    }

    /* Cookie Consent */
    .consent{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      max-width: 860px;
      margin: 0 auto;
      border-radius: 18px;
      border: 1px solid rgba(205,185,156,.9);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 26px rgba(0,0,0,.14);
      padding: 12px;
      z-index: 9999;
      display:none;
    }
    .consentTitle{
      font-family:"Kaisei Tokumin", serif;
      font-weight:900;
      letter-spacing:.06em;
      margin: 0 0 6px;
    }
    .consentText{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.6;
      margin: 0 0 10px;
    }
    .consentBtns{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }
    .consentBtns button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(205,185,156,.9);
      background: linear-gradient(180deg, #fff8ec, #f2e6d2);
      font-family:"Kaisei Tokumin", serif;
      font-weight:900;
      cursor:pointer;
    }
    .consentBtns button.secondary{
      background: rgba(255,255,255,.65);
      font-weight:800;
    }

    footer{
      margin-top: 18px;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.7;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <section class="card" aria-label="今日の推しジョッキー">
      <div class="stamp">推</div>
      <h1 class="title">今日の推しジョッキー</h1>
      <p class="subtitle">神社のおみくじ風に、今日の推しを授かります。</p>

      <div class="row">
        <button id="btnPickJockey" class="btn">勝負！</button>
        <button id="btnShareJockey" class="btn secondary" disabled>シェア</button>
      </div>

      <div id="jockeyResult" class="resultBox" style="display:none;">
        <div id="jockeyName" class="pickedName"></div>
        <a id="jockeyLink" class="linkBtn" href="#" target="_blank" rel="noopener noreferrer" style="display:none;">プロフィールを見る</a>
        <div id="jockeyErr" class="error" style="display:none;"></div>
      </div>

      <!-- 広告枠（審査中でも設置OK。承認後に表示される場合あり） -->
      <div class="adSlot" aria-label="広告枠">
        <div class="adSlotHead">広告</div>

        <!--
          重要：
          ここは「広告ユニットを作った後」に data-ad-slot を入れる場所。
          審査前は入れなくてもOK。Auto ads をONにする運用でもOK。
        -->
        <!--
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4459781035513186"
             data-ad-slot="XXXXXXXXXX"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        -->

        <div class="adNote">※審査中は広告が表示されない場合があります。</div>
      </div>
    </section>

    <div class="divider"></div>

    <section class="card" aria-label="馬券おみくじ">
      <div class="stamp">券</div>

      <div class="sectionHead">馬券おみくじ</div>
      <p class="subtitle">種類・頭数・点数・合計金額を選んで、「このレースのオススメ馬券」を引きます（ランダム）。</p>

      <div class="grid2">
        <div>
          <label for="betType">勝馬投票券</label>
          <select id="betType">
            <option value="WIN">単勝</option>
            <option value="PLC">複勝</option>
            <option value="WID">ワイド</option>
            <option value="UMR">馬連</option>
            <option value="QUO">馬単</option>
            <option value="TRI">3連複</option>
            <option value="TRF" selected>3連単</option>
          </select>
        </div>

        <div>
          <label for="fieldSize">レース頭数（2〜18）</label>
          <input id="fieldSize" type="number" inputmode="numeric" min="2" max="18" value="12" />
        </div>

        <div>
          <label for="points">点数（最大4通り）</label>
          <select id="points">
            <option value="1" selected>1点</option>
            <option value="2">2点</option>
            <option value="3">3点</option>
            <option value="4">4点</option>
          </select>
        </div>

        <div>
          <label for="totalAmount">合計金額（円）</label>
          <input id="totalAmount" type="number" inputmode="numeric" min="100" step="100" value="1000" />
        </div>
      </div>

      <div class="row" style="margin-top:14px;">
        <button id="btnPickBaken" class="btn">馬券おみくじ</button>
      </div>

      <div id="bakenResult" class="resultBox" style="display:none;">
        <div class="ticketWrap">
          <div id="ticketSvgMount"></div>
        </div>

        <div class="belowRow">
          <div class="sumText" id="sumText">合計：0円</div>
          <div class="omikujiStamp" id="omikujiStamp">吉</div>
        </div>

        <a id="shareBaken" class="shareLine" href="javascript:void(0)">この馬券をシェア</a>
        <div id="bakenErr" class="error" style="display:none;"></div>
      </div>

      <div class="smallNote">※4点でも票面の“下段合計”と被らないよう、行間を自動調整しています。</div>
    </section>

    <section class="card" aria-label="おすすめ・広告" style="margin-top:14px;">
      <div class="sectionHead">おすすめサイト</div>

      <div class="adsCard">
        <div class="adsTitle">おすすめ（PRを含む）</div>

        <div class="adsItem">
          <div class="name">Christophe Lemaire 公式サイト</div>
          <div class="desc">ルメール騎手をもっと深く。公式情報・最新ニュースなど。</div>
          <a href="https://c-lemaire.co.jp/" target="_blank" rel="noopener noreferrer">
            https://c-lemaire.co.jp/
          </a>
        </div>

        <div class="adsItem">
          <div class="name">馬券師の記録（ケイバオゼキ）</div>
          <div class="desc">最強馬券師「ケイバオゼキ」魂のロジカル馬券勝負</div>
          <a href="https://keiba-dashboard.vercel.app/" target="_blank" rel="noopener noreferrer">
            https://keiba-dashboard.vercel.app/
          </a>
        </div>
      </div>

      <div class="smallNote">※広告枠は今後「回転（ランダム表示）」や「クリック計測（解析）」にも拡張できます。</div>
    </section>

    <!-- ✅ ここから：AdSense 対策（おすすめサイトの次に追加） -->
    <section class="card" aria-label="プライバシー・ポリシー" style="margin-top:14px;">
      <div class="sectionHead">プライバシー・ポリシー等</div>
      <p class="subtitle">当サイトは広告配信（Google など）・アクセス解析のため、Cookie 等を利用する場合があります。</p>

      <div class="policyLinks">
        <a class="miniBtn" href="#privacy">プライバシーポリシー</a>
        <a class="miniBtn" href="#disclaimer">免責事項</a>
        <a class="miniBtn" href="#contact">お問い合わせ</a>
        <a class="miniBtn" href="#cookies">Cookieについて</a>
      </div>

      <details class="policy" id="privacy" open>
        <summary>プライバシーポリシー</summary>
        <div class="policyBody">
          <h3>広告配信について</h3>
          <p>
            当サイトでは、第三者配信の広告サービス（例：Google AdSense）を利用する予定があります。
            広告配信事業者は、ユーザーの興味に応じた広告を表示するために Cookie を使用することがあります。
          </p>
          <ul>
            <li>Cookie により取得される情報には、氏名・住所・メールアドレス・電話番号などの個人を特定する情報は含まれません。</li>
            <li>Cookie の使用を望まない場合、ブラウザ設定から無効にできます。</li>
          </ul>

          <h3>アクセス解析について</h3>
          <p>
            当サイトでは、サービス改善のためにアクセス解析を導入する場合があります。
            解析ツールは Cookie を使用し、トラフィックデータを収集することがありますが、個人を特定するものではありません。
          </p>

          <h3>個人情報の取り扱い</h3>
          <p>
            お問い合わせ等で取得した個人情報は、質問への回答や必要な連絡のみに利用し、
            本人の同意がある場合または法令に基づく場合を除き第三者に開示しません。
          </p>
        </div>
      </details>

      <details class="policy" id="cookies">
        <summary>Cookie（クッキー）について</summary>
        <div class="policyBody">
          <p>
            Cookie は、ウェブサイトがユーザーの端末に保存する小さなデータです。
            当サイトは、広告配信・アクセス解析・利便性向上のために Cookie を利用する場合があります。
          </p>
          <ul>
            <li>ユーザーはブラウザ設定で Cookie の拒否・削除が可能です。</li>
            <li>Cookie を無効にすると、サイトの一部機能が正しく動作しない場合があります。</li>
          </ul>
        </div>
      </details>

      <details class="policy" id="disclaimer">
        <summary>免責事項</summary>
        <div class="policyBody">
          <p>
            当サイトのコンテンツ（推しジョッキー/馬券おみくじ等）は娯楽目的で提供しています。
            掲載内容の正確性や安全性を保証するものではありません。
          </p>
          <ul>
            <li>当サイト利用により生じた損害等について、運営者は一切の責任を負いません。</li>
            <li>外部リンク先で提供される情報・サービスについて、当サイトは責任を負いません。</li>
            <li>競馬等の投票行為は、各自の判断と責任のもとで行ってください。</li>
          </ul>
        </div>
      </details>

      <details class="policy" id="contact">
        <summary>お問い合わせ</summary>
        <div class="policyBody">
          <p>
            お問い合わせは以下からお願いいたします（暫定）。
          </p>
          <ul>
            <li>メール：<span id="contactEmail">（未設定）</span></li>
            <li>または、X / Instagram などのSNS（運用開始後にここを更新）</li>
          </ul>
          <p class="smallNote">
            ※メールアドレスを公開したくない場合は、Googleフォーム等のリンクに差し替えるのがおすすめです。
          </p>
        </div>
      </details>

      <div class="smallNote">
        ※EEA/英国/スイス向けに同意取得（CMP）が必要な場合があります。AdSense 管理画面の案内に沿って CMP を設定してください。
      </div>
    </section>

    <footer>
      <div>© <span id="year"></span> 今日の推しジョッキー</div>
      <div>本サイトは娯楽コンテンツです。投票は自己責任で。</div>
    </footer>

  </div>

  <!-- Cookie同意（簡易版：表示/非表示のみ。CMPの代替ではありません） -->
  <div class="consent" id="consent">
    <div class="consentTitle">Cookie の利用について</div>
    <p class="consentText">
      当サイトは、広告配信・アクセス解析のために Cookie を利用する場合があります。
      「同意する」を押すと Cookie の利用に同意したものとみなします。
      （※EEA/英国/スイス向けにはCMP対応が必要になる場合があります）
    </p>
    <div class="consentBtns">
      <button id="consentAccept">同意する</button>
      <button id="consentReject" class="secondary">同意しない</button>
    </div>
  </div>

<script>
  const yen = (n) => new Intl.NumberFormat("ja-JP").format(Math.round(n)) + "円";
  const pad2 = (n) => String(n).padStart(2, "0");
  const clampInt = (v, min, max) => {
    const n = Math.floor(Number(v));
    if (Number.isNaN(n)) return min;
    return Math.max(min, Math.min(max, n));
  };
  const choice = (arr) => arr[Math.floor(Math.random() * arr.length)];
  const uniq = (arr) => Array.from(new Set(arr));

  // -------------------------
  // 推しジョッキー（既存API）
  // -------------------------
  const btnPickJockey = document.getElementById("btnPickJockey");
  const btnShareJockey = document.getElementById("btnShareJockey");
  const jockeyResult = document.getElementById("jockeyResult");
  const jockeyNameEl = document.getElementById("jockeyName");
  const jockeyLinkEl = document.getElementById("jockeyLink");
  const jockeyErrEl = document.getElementById("jockeyErr");

  let lastJockey = null;

  async function shareText(text){
    const url = location.href;
    try{
      if (navigator.share){
        await navigator.share({ text, url, title: "今日の推しジョッキー" });
      }else{
        await navigator.clipboard.writeText(text + "\n" + url);
        alert("シェア文をコピーしました。");
      }
    }catch(e){}
  }

  async function pickJockey(){
    jockeyErrEl.style.display = "none";
    jockeyLinkEl.style.display = "none";
    jockeyNameEl.textContent = "";
    jockeyResult.style.display = "block";
    btnShareJockey.disabled = true;
    lastJockey = null;

    try{
      const res = await fetch("/api/oshi-jockey", { cache: "no-store" });
      const text = await res.text();

      let data;
      try { data = JSON.parse(text); }
      catch(e){
        throw new Error("JSON解析に失敗しました。\n" + text.slice(0, 180));
      }

      if (!data || data.error){
        throw new Error(data?.message || "取得に失敗しました。");
      }

      const picked = data.picked || data || {};
      const name = picked.name || "(ジョッキー)";
      const profileUrl = picked.profileUrl || picked.url || "";

      jockeyNameEl.textContent = name;

      if (profileUrl){
        jockeyLinkEl.href = profileUrl;
        jockeyLinkEl.style.display = "inline-block";
      }

      lastJockey = { name, profileUrl };
      btnShareJockey.disabled = false;

    }catch(err){
      jockeyErrEl.textContent = String(err?.message || err);
      jockeyErrEl.style.display = "block";
    }
  }

  btnPickJockey.addEventListener("click", pickJockey);
  btnShareJockey.addEventListener("click", async () => {
    if (!lastJockey) return;
    const t = `今日の推しジョッキーは「${lastJockey.name}」でした。勝負！`;
    await shareText(t);
  });

  // -------------------------
  // 馬券おみくじ（フロント）
  // -------------------------
  const betTypeEl = document.getElementById("betType");
  const fieldSizeEl = document.getElementById("fieldSize");
  const pointsEl = document.getElementById("points");
  const totalAmountEl = document.getElementById("totalAmount");
  const btnPickBaken = document.getElementById("btnPickBaken");

  const bakenResult = document.getElementById("bakenResult");
  const ticketSvgMount = document.getElementById("ticketSvgMount");
  const sumTextEl = document.getElementById("sumText");
  const omikujiStampEl = document.getElementById("omikujiStamp");
  const shareBakenEl = document.getElementById("shareBaken");
  const bakenErrEl = document.getElementById("bakenErr");

  let lastBaken = null;

  const VENUES = ["東京","中山","京都","阪神","札幌","函館","福島","新潟","中京","小倉"];

  const BET_DEF = {
    WIN: { label: "単勝",  min: 1, pickSize: 1, ordered: false },
    PLC: { label: "複勝",  min: 1, pickSize: 1, ordered: false },
    WID: { label: "ワイド", min: 2, pickSize: 2, ordered: false },
    UMR: { label: "馬連",  min: 2, pickSize: 2, ordered: false },
    QUO: { label: "馬単",  min: 2, pickSize: 2, ordered: true  },
    TRI: { label: "3連複", min: 3, pickSize: 3, ordered: false },
    TRF: { label: "3連単", min: 3, pickSize: 3, ordered: true  },
  };

  function randHorseNo(max){ return Math.floor(Math.random() * max) + 1; }

  function buildOnePick(betKey, fieldSize){
    const def = BET_DEF[betKey];
    const need = def.pickSize;

    let nums = [];
    while(nums.length < need){
      nums.push(randHorseNo(fieldSize));
      nums = uniq(nums);
    }
    if (!def.ordered) nums.sort((a,b)=>a-b);
    return nums;
  }

  function buildPicks(betKey, fieldSize, points){
    const picks = [];
    let guard = 0;
    while(picks.length < points && guard < 100){
      const p = buildOnePick(betKey, fieldSize);
      const key = p.join("-");
      if (!picks.some(x => x.join("-") === key)){
        picks.push(p);
      }
      guard++;
    }
    return picks;
  }

  function splitAmount(total, points){
    total = Math.max(100, Math.round(total / 100) * 100);
    const base = Math.floor(total / points / 100) * 100;
    let rest = total - base * points;

    const alloc = new Array(points).fill(base);
    let i = 0;
    while(rest > 0){
      alloc[i] += 100;
      rest -= 100;
      i = (i + 1) % points;
    }
    return alloc;
  }

  function omikujiFromTotal(){
    const pool = ["大吉","中吉","吉","小吉","末吉"];
    return choice(pool);
  }

  function escapeXml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function makeTicketSVG(model){
    const W = 980;
    const H = 300;

    const venue = model.venue;
    const raceNo = model.raceNo;
    const day = model.day;

    const betLabel = model.betLabel;
    const betKey = model.betKey;
    const picks = model.picks;
    const alloc = model.alloc;
    const fieldSize = model.fieldSize;
    const points = model.points;
    const total = model.total;

    const betChars = Array.from(String(betLabel));
    const betCharY0 = 132;
    const betCharGap = 34;

    const rowsTop = 74;
    const rowsBottom = 210;
    const maxGap = 54;
    const minGap = 42;
    const rowGapRaw = (points > 1) ? Math.floor((rowsBottom - rowsTop) / (points - 1)) : 0;
    const rowGap = Math.max(minGap, Math.min(maxGap, rowGapRaw));

    const rightX = 540;
    const rightY0 = rowsTop;
    const chipW = 52;
    const chipH = 34;
    const chipGap = 16;

    const amountTextX = 922;

    const totalLabelY = 286;
    const totalAmountY = 288;

    const bg = `
      <defs>
        <linearGradient id="paperGrad" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%" stop-color="#dff3ef" stop-opacity="0.70"/>
          <stop offset="35%" stop-color="#ffffff" stop-opacity="0.65"/>
          <stop offset="100%" stop-color="#e6f4f2" stop-opacity="0.65"/>
        </linearGradient>
        <pattern id="stripe" width="10" height="10" patternUnits="userSpaceOnUse">
          <path d="M0 10 L10 0" stroke="#1b1b1b" stroke-opacity="0.15" stroke-width="2"/>
        </pattern>
        <clipPath id="clipR">
          <rect x="0" y="0" width="${W}" height="${H}" rx="18" ry="18"/>
        </clipPath>
      </defs>

      <g clip-path="url(#clipR)">
        <rect x="0" y="0" width="${W}" height="${H}" fill="url(#paperGrad)"/>
        <circle cx="760" cy="140" r="120" fill="#e47d8a" opacity="0.10"/>
        <circle cx="860" cy="210" r="90"  fill="#5fb0a3" opacity="0.10"/>
        <circle cx="700" cy="220" r="80"  fill="#5fb0a3" opacity="0.08"/>
        <rect x="0" y="0" width="${W}" height="${H}" fill="none" stroke="#111" stroke-width="4"/>
      </g>
    `;

    const left = `
      <g>
        <text x="34" y="62" font-size="44" font-weight="800" font-family="serif">${escapeXml(venue)}</text>
        <text x="176" y="58" font-size="22" font-family="serif">(${escapeXml(day)})</text>

        <rect x="34" y="78" width="92" height="74" rx="10" fill="#111"/>
        <text x="80" y="128" text-anchor="middle" font-size="36" fill="#fff" font-family="system-ui, sans-serif" font-weight="800">${raceNo}</text>

        <text x="142" y="126" font-size="28" font-family="serif" font-weight="700">レース</text>

        <rect x="34" y="160" width="84" height="84" rx="10" fill="#fff" stroke="#111" stroke-opacity="0.35"/>
        <rect x="128" y="160" width="84" height="84" rx="10" fill="#fff" stroke="#111" stroke-opacity="0.35"/>
        <rect x="34" y="160" width="84" height="84" rx="10" fill="url(#stripe)" opacity="0.35"/>
        <rect x="128" y="160" width="84" height="84" rx="10" fill="url(#stripe)" opacity="0.35"/>

        <text x="34" y="276" font-size="18" fill="#333" font-family="serif">頭数：${fieldSize} / 点数：${points}</text>
      </g>
    `;

    const mid = `
      <g>
        <rect x="330" y="52" width="108" height="210" fill="#fff" stroke="#111" stroke-width="3"/>
        <text x="384" y="88" text-anchor="middle" font-size="16" font-family="system-ui, sans-serif" font-weight="800">${escapeXml(betKey)}</text>
        <text x="384" y="260" text-anchor="middle" font-size="16" font-family="system-ui, sans-serif" font-weight="800">${escapeXml(betKey)}</text>

        ${betChars.map((ch, i) => `
          <text x="384" y="${betCharY0 + i*betCharGap}" text-anchor="middle"
            font-size="38" font-family="serif" font-weight="900">${escapeXml(ch)}</text>
        `).join("")}
      </g>
    `;

    const rightRows = picks.slice(0,4).map((nums, idx) => {
      const y = rightY0 + idx * rowGap;
      const amt = alloc[idx] ?? 0;

      const chips = nums.map((n, j) => {
        const x = rightX + j * (chipW + chipGap + 18);
        const chip = `
          <rect x="${x}" y="${y}" width="${chipW}" height="${chipH}" rx="7" fill="#fff" stroke="#111" stroke-width="2"/>
          <text x="${x + chipW/2}" y="${y + 24}" text-anchor="middle" font-size="18" font-family="system-ui, sans-serif" font-weight="800">${pad2(n)}</text>
        `;
        const arrow = (j < nums.length - 1)
          ? `<text x="${x + chipW + 10}" y="${y + 24}" font-size="20" font-family="system-ui, sans-serif" font-weight="800">→</text>`
          : "";
        return chip + arrow;
      }).join("");

      const amtText = `× ${new Intl.NumberFormat("ja-JP").format(amt)}円`;

      return `
        <g>
          ${chips}
          <text x="${amountTextX}" y="${y + 24}" text-anchor="end" font-size="18" font-family="system-ui, sans-serif" font-weight="800">${escapeXml(amtText)}</text>
        </g>
      `;
    }).join("");

    const right = `
      <g>
        ${rightRows}
        <text x="520" y="${totalLabelY}" font-size="20" font-family="serif" font-weight="800">合計</text>
        <text x="650" y="${totalAmountY}" font-size="36" font-family="system-ui, sans-serif" font-weight="900">${new Intl.NumberFormat("ja-JP").format(total)}円</text>
      </g>
    `;

    return `
      <svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="馬券おみくじ結果">
        ${bg}
        ${left}
        ${mid}
        ${right}
      </svg>
    `;
  }

  function buildBakenModel(){
    const betKey = betTypeEl.value;
    const def = BET_DEF[betKey];

    const fieldSize = clampInt(fieldSizeEl.value, 2, 18);
    const points = clampInt(pointsEl.value, 1, 4);
    const total = Math.max(100, Math.round(Number(totalAmountEl.value || 0) / 100) * 100);

    if (!def) throw new Error("券種が不正です。");
    if (fieldSize < def.min) throw new Error(`${def.label}は頭数${def.min}以上が必要です。`);

    const picks = buildPicks(betKey, fieldSize, points);
    const alloc = splitAmount(total, picks.length);

    return {
      venue: choice(VENUES),
      day: "日",
      raceNo: Math.floor(Math.random() * 12) + 1,
      betKey,
      betLabel: def.label,
      fieldSize,
      points: picks.length,
      picks,
      alloc,
      total: alloc.reduce((a,b)=>a+b,0),
      omikuji: omikujiFromTotal()
    };
  }

  function formatBakenShareText(model){
    const lines = model.picks.map((nums, i) => {
      const buy = nums.map(n => pad2(n)).join("-");
      const a = model.alloc[i] ?? 0;
      return `${buy}（${yen(a)}）`;
    });

    return [
      `【馬券おみくじ】`,
      `券種：${model.betLabel}`,
      `頭数：${model.fieldSize} / 点数：${model.points}`,
      `買い目：${lines.join(" / ")}`,
      `合計：${yen(model.total)}`,
      `運勢：${model.omikuji}`,
      ``,
      `#今日の推しジョッキー #馬券おみくじ`
    ].join("\n");
  }

  btnPickBaken.addEventListener("click", () => {
    bakenErrEl.style.display = "none";
    bakenResult.style.display = "block";
    ticketSvgMount.innerHTML = "";

    try{
      const model = buildBakenModel();
      lastBaken = model;

      ticketSvgMount.innerHTML = makeTicketSVG(model);
      sumTextEl.textContent = `合計：${yen(model.total)}`;
      omikujiStampEl.textContent = model.omikuji;

    }catch(err){
      bakenErrEl.textContent = String(err?.message || err);
      bakenErrEl.style.display = "block";
    }
  });

  shareBakenEl.addEventListener("click", async () => {
    if (!lastBaken) return;
    const text = formatBakenShareText(lastBaken);
    await shareText(text);
  });

  // -------------------------
  // Footer / Consent
  // -------------------------
  document.getElementById("year").textContent = String(new Date().getFullYear());

  const consentEl = document.getElementById("consent");
  const key = "oj_consent_v1";
  const saved = localStorage.getItem(key);

  if (!saved){
    consentEl.style.display = "block";
  }

  document.getElementById("consentAccept").addEventListener("click", () => {
    localStorage.setItem(key, "accept");
    consentEl.style.display = "none";
  });
  document.getElementById("consentReject").addEventListener("click", () => {
    localStorage.setItem(key, "reject");
    consentEl.style.display = "none";
  });
</script>
</body>
</html>
