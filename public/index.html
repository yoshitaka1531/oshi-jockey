<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>今日の推しジョッキー</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Yuji+Boku&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#1a1a1a;
      --paper:#fbf7ee;
      --paper2:#f3ead6;
      --line:#d9cdb5;
      --seal:#b00020;
      --indigo:#1a4aa5;
      --card: rgba(255,255,255,.55);
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      padding:20px 14px 28px;
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(0,0,0,.04), transparent 60%),
        radial-gradient(900px 700px at 80% 0%, rgba(0,0,0,.03), transparent 55%),
        linear-gradient(180deg, var(--paper), var(--paper2));
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
    }
    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:
        repeating-linear-gradient(0deg, rgba(0,0,0,.015) 0, rgba(0,0,0,.015) 1px, transparent 1px, transparent 4px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.01) 0, rgba(0,0,0,.01) 1px, transparent 1px, transparent 5px);
      mix-blend-mode:multiply;
      opacity:.35;
    }

    .wrap{ max-width:820px; margin:0 auto; position:relative; }
    .title{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:40px;
      letter-spacing:.08em;
      margin:0 0 8px;
      line-height:1.1;
    }
    .subtitle{ margin:0 0 18px; color:#444; font-size:13px; }

    .card{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:18px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      position:relative;
      overflow:hidden;
      margin-bottom:14px;
    }

    .stamp{
      position:absolute;
      right:16px;
      top:14px;
      width:64px;
      height:64px;
      border:3px solid rgba(176,0,32,.55);
      color:rgba(176,0,32,.75);
      display:grid;
      place-items:center;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:28px;
      transform:rotate(9deg);
      border-radius:10px;
      background:rgba(255,255,255,.25);
    }

    .sectionTitle{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:28px;
      letter-spacing:.10em;
      margin:0 0 8px;
    }

    .desc{ margin:0 0 12px; color:#444; font-size:14px; line-height:1.6; }

    .btnrow{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:10px 0 0; }
    .btn{
      border:1px solid #cbbd9f;
      background:linear-gradient(180deg, #fffdf7, #f3ead6);
      color:var(--ink);
      border-radius:14px;
      padding:12px 18px;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.08);
      transition:transform .08s ease, box-shadow .08s ease;
      font-size:16px;
      min-width: 148px;
    }
    .btn:active{ transform:translateY(1px); box-shadow:0 4px 12px rgba(0,0,0,.08); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .btn.main{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:22px;
      letter-spacing:.18em;
      padding:14px 22px;
      border-color:#b9a27a;
      min-width: 180px;
    }
    .btn.share{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      letter-spacing:.08em;
      min-width: 120px;
    }

    .resultBox{
      margin-top:14px;
      padding:16px;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.62);
    }
    .name{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:30px;
      letter-spacing:.10em;
      margin:0 0 10px;
    }
    a{ color:var(--indigo); text-decoration:underline; text-underline-offset:3px; }
    a:hover{ opacity:.85; }

    .metaLine{ font-size:12px; color:#555; margin-top:8px; display:none; }
    .err{ margin-top:10px; white-space:pre-wrap; color:var(--seal); font-size:13px; display:none; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width:680px){
      .grid{ grid-template-columns:1fr; }
      .btn{ width:100%; }
      .btn.main{ width:100%; }
    }
    label{ font-size:13px; color:#333; display:block; margin:4px 0 6px; }
    select, input{
      width:100%;
      border:1px solid #cbbd9f;
      background:rgba(255,255,255,.7);
      border-radius:14px;
      padding:12px 14px;
      font-size:18px;
      outline:none;
    }

    .ticketWrap{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.55);
      padding:12px;
      overflow:hidden;
    }
    .ticketSvg{ width:100%; height:auto; display:block; }

    .ticketFooter{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      margin-top:10px;
    }
    .omikujiSum{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:22px;
      letter-spacing:.08em;
      margin:0;
    }
    .fortuneStamp{
      width:70px;
      height:70px;
      border:3px solid rgba(176,0,32,.55);
      color:rgba(176,0,32,.75);
      display:grid;
      place-items:center;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:22px;
      transform:rotate(9deg);
      border-radius:12px;
      background:rgba(255,255,255,.25);
      flex:0 0 auto;
    }

    .footer{
      margin-top:14px;
      padding:14px 16px;
      border:1px dashed #cbbd9f;
      border-radius:16px;
      background:rgba(255,255,255,.45);
    }
    .footer h2{
      margin:0 0 8px;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:18px;
      letter-spacing:.08em;
    }
    .footlink{ word-break:break-all; }
    .tinyNote{ font-size:12px; color:#666; margin-top:10px; line-height:1.5; }
  </style>
</head>

<body>
  <div class="wrap">

    <section class="card">
      <div class="stamp">推</div>
      <h1 class="title">今日の推しジョッキー</h1>
      <p class="subtitle">神社のおみくじ風に、今日の推しを授かります。</p>

      <div class="btnrow">
        <button id="drawBtn" class="btn main">勝負！</button>
        <button id="shareBtn" class="btn share" disabled>シェア</button>
      </div>

      <div id="jockeyBox" class="resultBox" style="display:none;">
        <div id="jockeyName" class="name"></div>
        <a id="jockeyLink" href="#" target="_blank" rel="noopener noreferrer">プロフィールを見る</a>
        <div id="jockeyMeta" class="metaLine"></div>
      </div>

      <pre id="jockeyErr" class="err"></pre>
    </section>

    <section class="card">
      <div class="stamp">券</div>
      <h2 class="sectionTitle">馬券おみくじ</h2>
      <p class="desc">
        種類・頭数・点数・合計金額を選んで、「このレースのオススメ馬券」を引きます（ランダム）。
      </p>

      <div class="grid">
        <div>
          <label for="betType">勝馬投票券</label>
          <select id="betType">
            <option>単勝</option>
            <option>複勝</option>
            <option>枠連</option>
            <option>馬連</option>
            <option>ワイド</option>
            <option>馬単</option>
            <option>3連複</option>
            <option>3連単</option>
          </select>
        </div>

        <div>
          <label for="fieldSize">レース頭数（2〜18）</label>
          <input id="fieldSize" type="number" min="2" max="18" value="12" />
        </div>

        <div>
          <label for="points">点数</label>
          <select id="points">
            <option value="1">1点</option>
            <option value="3">3点</option>
            <option value="5">5点</option>
          </select>
        </div>

        <div>
          <label for="budget">合計金額（円）</label>
          <input id="budget" type="number" min="100" step="100" value="1000" />
        </div>
      </div>

      <div class="btnrow" style="margin-top:14px;">
        <button id="bakenBtn" class="btn main">馬券おみくじ</button>
      </div>

      <div id="ticketArea" class="ticketWrap" style="display:none;">
        <div id="ticketSvgHolder"></div>

        <div class="ticketFooter">
          <p class="omikujiSum" id="ticketSumText">合計：0円</p>
          <div class="fortuneStamp" id="fortuneStamp">吉</div>
        </div>

        <div style="margin-top:10px;">
          <a id="shareTicketLink" href="#" role="button">この馬券をシェア</a>
        </div>

        <pre id="ticketErr" class="err"></pre>
      </div>

      <div class="tinyNote">
        ※UMAJOや外部サイトの構造変更・通信状況により、取得に時間がかかる場合があります。<br>
        ※馬券おみくじは娯楽用のランダム生成です。
      </div>
    </section>

    <section class="footer">
      <h2>おすすめサイト</h2>
      <a class="footlink" href="https://c-lemaire.co.jp/?srsltid=AfmBOop6TBukVoj2Y2Cs9SYRuY_8TsMUwtuXH3sUJPnIAXSxN-VKYrgq" target="_blank" rel="noopener noreferrer">
        https://c-lemaire.co.jp/
      </a>
    </section>

  </div>

  <script>
    function clampInt(v, min, max){
      const n = Number(v);
      if(!Number.isFinite(n)) return min;
      return Math.min(max, Math.max(min, Math.trunc(n)));
    }
    function pickOne(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // ===== 今日の推しジョッキー =====
    const drawBtn = document.getElementById("drawBtn");
    const shareBtn = document.getElementById("shareBtn");
    const jockeyBox = document.getElementById("jockeyBox");
    const jockeyNameEl = document.getElementById("jockeyName");
    const jockeyLinkEl = document.getElementById("jockeyLink");
    const jockeyErrEl = document.getElementById("jockeyErr");
    const jockeyMetaEl = document.getElementById("jockeyMeta");

    let latestJockey = null;

    async function fetchJockey(){
      jockeyErrEl.style.display = "none";
      jockeyErrEl.textContent = "";
      shareBtn.disabled = true;
      drawBtn.disabled = true;
      drawBtn.textContent = "祈願中…";

      try{
        const res = await fetch("/api/oshi-jockey", { cache: "no-store" });
        const text = await res.text();
        let data;
        try{ data = JSON.parse(text); }
        catch(e){ throw new Error("APIがJSONを返しませんでした。\n" + text.slice(0,200)); }

        if(!res.ok || data.error) throw new Error(data.message || "取得に失敗しました。");

        latestJockey = data.picked;
        jockeyNameEl.textContent = latestJockey.name || "(ジョッキー)";
        jockeyLinkEl.href = latestJockey.profileUrl || "https://umajo.jra.jp/jockey/";
        jockeyBox.style.display = "block";

        jockeyMetaEl.textContent = data.totalCandidates ? `候補数：${data.totalCandidates}` : "";
        shareBtn.disabled = false;
      }catch(err){
        jockeyErrEl.style.display = "block";
        jockeyErrEl.textContent = String(err && err.message ? err.message : err);
      }finally{
        drawBtn.disabled = false;
        drawBtn.textContent = "勝負！";
      }
    }

    async function shareCommon(text){
      try{
        if(navigator.share){
          await navigator.share({ text });
          return true;
        }
      }catch(e){}
      try{
        await navigator.clipboard.writeText(text);
        alert("シェア文言をコピーしました。");
        return true;
      }catch(e){
        prompt("コピーしてシェアしてください：", text);
        return true;
      }
    }

    function shareTextBase(){
      const baseUrl = location.href;
      const jockeyText = latestJockey ? `今日の推しジョッキー：${latestJockey.name}` : "今日の推しジョッキー：未取得";
      return `${jockeyText}\n${baseUrl}\n#今日の推しジョッキー`;
    }

    drawBtn.addEventListener("click", fetchJockey);
    shareBtn.addEventListener("click", async ()=>{ await shareCommon(shareTextBase()); });

    // ===== 馬券おみくじ（フロント） =====
    const betTypeEl = document.getElementById("betType");
    const fieldSizeEl = document.getElementById("fieldSize");
    const pointsEl = document.getElementById("points");
    const budgetEl = document.getElementById("budget");
    const bakenBtn = document.getElementById("bakenBtn");
    const ticketArea = document.getElementById("ticketArea");
    const ticketSvgHolder = document.getElementById("ticketSvgHolder");
    const ticketSumText = document.getElementById("ticketSumText");
    const fortuneStamp = document.getElementById("fortuneStamp");
    const shareTicketLink = document.getElementById("shareTicketLink");
    const ticketErr = document.getElementById("ticketErr");

    let latestTicket = null;
    const VENUES = ["東京","中山","京都","阪神","中京","札幌","函館","福島","新潟","小倉"];

    function uniqueNums(count, max){
      const arr = [];
      for(let i=1;i<=max;i++) arr.push(i);
      return shuffle(arr).slice(0, count);
    }

    function makePick(typeLabel, fieldSize){
      let raw = [];
      if(typeLabel === "単勝" || typeLabel === "複勝"){
        raw = uniqueNums(1, fieldSize);
      }else if(typeLabel === "枠連" || typeLabel === "馬連" || typeLabel === "ワイド"){
        raw = uniqueNums(2, fieldSize).sort((a,b)=>a-b);
      }else if(typeLabel === "馬単"){
        raw = uniqueNums(2, fieldSize);
      }else if(typeLabel === "3連複"){
        raw = uniqueNums(3, fieldSize).sort((a,b)=>a-b);
      }else if(typeLabel === "3連単"){
        raw = uniqueNums(3, fieldSize);
      }else{
        raw = uniqueNums(1, fieldSize);
      }
      const sep = (typeLabel === "馬単" || typeLabel === "3連単") ? "→" : "−";
      const text = raw.map(n => String(n).padStart(2,"0")).join(sep);
      return { raw, text };
    }

    function allocateBudget(total, points){
      const unit = 100;
      const t = Math.max(unit, Math.floor(total/unit)*unit);
      const p = Math.max(1, points);
      const base = Math.floor(t/p/unit)*unit;
      const alloc = new Array(p).fill(base);
      let rem = t - base*p;
      let i = 0;
      while(rem > 0){
        alloc[i] += unit;
        rem -= unit;
        i = (i+1) % p;
      }
      return { total: t, alloc };
    }

    function randomFortune(){
      const list = ["大吉","中吉","吉","小吉","末吉"];
      return pickOne(list);
    }

    // ====== ここが改修ポイント：縦書き（枠内固定） ======
    function splitTypeForVertical(typeLabel){
      // 3連単 / 3連複 の「3」と「連」を分けると本物感が出る
      // 例: "3連単" -> ["3","連","単"]
      //     "単勝"   -> ["単","勝"]
      //     "ワイド" -> ["ワ","イ","ド"]
      const s = String(typeLabel);
      if(s.startsWith("3連") && s.length === 3){
        return [s[0], s[1], s[2]];
      }
      // カタカナは1文字ずつ
      if(/[ァ-ヶー]/.test(s)){
        return s.split("");
      }
      // 漢字も1文字ずつ
      return s.split("");
    }

    function makeTicketSVG({ venue, raceNo, typeLabel, fieldSize, points, picks, alloc, total }){
      const W = 1020, H = 430;

      const codeMap = {
        "単勝":"WIN", "複勝":"PLC", "枠連":"WAK", "馬連":"UMR",
        "ワイド":"WID", "馬単":"UMT", "3連複":"TRI", "3連単":"TRF"
      };
      const betCode = codeMap[typeLabel] || "BET";
      const pad2 = (n) => String(n).padStart(2, "0");

      const isOrdered = (typeLabel === "馬単" || typeLabel === "3連単");
      const sepChar = isOrdered ? "→" : "−";

      const bg = `
        <defs>
          <pattern id="vstripe" width="10" height="10" patternUnits="userSpaceOnUse">
            <rect width="10" height="10" fill="#f7fbf7"></rect>
            <rect width="5" height="10" fill="#e6f5ee"></rect>
          </pattern>
        </defs>
        <rect x="0" y="0" width="${W}" height="${H}" fill="url(#vstripe)"/>
        <g opacity="0.07">
          <circle cx="780" cy="160" r="130" fill="#1a4aa5"/>
          <circle cx="900" cy="285" r="150" fill="#b00020"/>
          <path d="M640 70 C690 30, 760 30, 810 70 C860 110, 860 180, 810 220 C760 260, 690 260, 640 220 C590 180, 590 110, 640 70 Z"
                fill="#0a7a43" opacity="0.35"/>
        </g>
      `;

      function pseudoQR(x,y){
        const cells = 12, cell = 10, size = cells*cell + 16;
        let blocks = "";
        for(let r=0;r<cells;r++){
          for(let c=0;c<cells;c++){
            const on = ((r*7 + c*11 + r + c) % 5) === 0;
            if(on) blocks += `<rect x="${x+8+c*cell}" y="${y+8+r*cell}" width="${cell-2}" height="${cell-2}" fill="#111" opacity="0.65"/>`;
          }
        }
        return `
          <g>
            <rect x="${x}" y="${y}" width="${size}" height="${size}" rx="10" fill="#fff" stroke="#111" stroke-width="2" opacity="0.98"/>
            ${blocks}
          </g>
        `;
      }

      const leftX = 28;
      const left = `
        <g font-family="system-ui, -apple-system, 'Noto Sans JP', sans-serif" fill="#111">
          <text x="${leftX}" y="56" font-size="48" font-weight="900">${venue}</text>
          <text x="${leftX+178}" y="56" font-size="26" font-weight="700">（日）</text>

          <rect x="${leftX}" y="80" width="126" height="86" rx="10" fill="#111"/>
          <text x="${leftX+63}" y="138" font-size="54" font-weight="900" fill="#fff" text-anchor="middle">${raceNo}</text>
          <text x="${leftX+148}" y="138" font-size="34" font-weight="900">レース</text>

          ${pseudoQR(leftX, 190)}
          ${pseudoQR(leftX+178, 190)}

          <text x="${leftX}" y="382" font-size="18" opacity="0.9">頭数：${fieldSize} / 点数：${points}</text>
          <text x="${leftX}" y="405" font-size="12" opacity="0.65">※この画像はランダム生成です</text>
        </g>
      `;

      // ====== 縦枠（式別）を“枠内に収める” ======
      const chars = splitTypeForVertical(typeLabel);
      const maxLines = 4; // 最大4行まで（ほぼ収まる）
      const safeChars = chars.slice(0, maxLines);

      const rectX = 386, rectY = 44, rectW = 132, rectH = 338;
      const innerTop = rectY + 78;     // 上のコード表示(22px)の下あたり
      const innerBottom = rectY + rectH - 58; // 下のコード表示の上あたり
      const innerH = innerBottom - innerTop;

      // 行数に応じてフォントサイズと行間を自動調整して枠内固定
      const lines = safeChars.length;
      const fontSize = Math.floor(Math.min(62, Math.max(34, innerH / (lines + 0.2))));
      const lineStep = Math.floor(innerH / lines);

      // それぞれの文字を1行ずつ配置（white-space依存をやめて確実に枠内に）
      let vTexts = "";
      for(let i=0;i<lines;i++){
        const y = innerTop + Math.floor(lineStep*(i+0.65));
        vTexts += `
          <text x="452" y="${y}" font-size="${fontSize}" font-weight="900" text-anchor="middle"
                font-family="system-ui, -apple-system, 'Noto Sans JP', sans-serif">
            ${safeChars[i]}
          </text>
        `;
      }

      const center = `
        <g font-family="system-ui, -apple-system, 'Noto Sans JP', sans-serif" fill="#111">
          <rect x="${rectX}" y="${rectY}" width="${rectW}" height="${rectH}" fill="#fff" stroke="#111" stroke-width="5"/>
          <text x="452" y="80" font-size="22" font-weight="900" text-anchor="middle" opacity="0.85">${betCode}</text>
          ${vTexts}
          <text x="452" y="354" font-size="22" font-weight="900" text-anchor="middle" opacity="0.85">${betCode}</text>
        </g>
      `;

      function renderPickBoxes(rawNums, x, y){
        const n = rawNums.length;
        const boxW = 70, boxH = 54;
        const sepW = 26;
        const gap = 12;
        const areaW = 320;
        const totalW = (n*boxW) + ((n-1)*sepW) + ((n-1)*gap);
        const startX = x + Math.floor((areaW - totalW)/2);

        let out = "";
        for(let i=0;i<n;i++){
          const bx = startX + i*(boxW + gap + sepW);
          out += `
            <rect x="${bx}" y="${y}" width="${boxW}" height="${boxH}" rx="10"
                  fill="#fff" stroke="#111" stroke-width="3"/>
            <text x="${bx + boxW/2}" y="${y + 37}" font-size="26" font-weight="900"
                  text-anchor="middle"
                  font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace">
              ${pad2(rawNums[i])}
            </text>
          `;
          if(i < n - 1){
            const sx = bx + boxW + Math.floor(gap/2) + Math.floor(sepW/2);
            out += `
              <text x="${sx}" y="${y + 38}" font-size="30" font-weight="900"
                    text-anchor="middle"
                    font-family="system-ui, -apple-system, 'Noto Sans JP', sans-serif">
                ${sepChar}
              </text>
            `;
          }
        }
        return out;
      }

      const linesData = picks.map((p,i)=>({
        raw: (p.raw && p.raw.length ? p.raw : (String(p.text).match(/\d+/g)||[]).map(Number).slice(0,3)),
        yen: alloc[i] || 0
      }));

      const buyX = 560;
      const moneyX = 898;

      const right = `
        <g font-family="system-ui, -apple-system, 'Noto Sans JP', sans-serif" fill="#111">
          ${linesData.map((ln, idx)=>{
            const y = 96 + idx*74;
            return `
              <g>
                ${renderPickBoxes(ln.raw, buyX, y)}
                <rect x="${moneyX}" y="${y}" width="112" height="54" rx="10"
                      fill="#fff" stroke="#111" stroke-width="3"/>
                <text x="${moneyX+56}" y="${y+36}" font-size="18" font-weight="900" text-anchor="middle"
                      font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace">
                  × ${ln.yen.toLocaleString()}円
                </text>
              </g>
            `;
          }).join("")}

          <text x="560" y="392" font-size="22" font-weight="900" opacity="0.95">合計</text>
          <text x="640" y="392" font-size="46" font-weight="900"
                font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace">
            ${total.toLocaleString()}円
          </text>
        </g>
      `;

      const frame = `<rect x="8" y="8" width="${W-16}" height="${H-16}" rx="18" fill="none" stroke="#111" stroke-width="6"/>`;
      const topLabel = `
        <g font-family="system-ui, -apple-system, 'Noto Sans JP', sans-serif" fill="#111" opacity="0.85">
          <text x="28" y="26" font-size="14" font-weight="700">勝馬投票券（イメージ）</text>
        </g>
      `;

      return `
        <svg class="ticketSvg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="馬券">
          ${bg}
          ${topLabel}
          ${left}
          ${center}
          ${right}
          ${frame}
        </svg>
      `;
    }

    function renderTicket(ticket){
      ticketSvgHolder.innerHTML = makeTicketSVG(ticket);
      ticketSumText.textContent = `合計：${ticket.total.toLocaleString()}円`;
      fortuneStamp.textContent = ticket.fortune;
      ticketArea.style.display = "block";
    }

    async function svgToPngBlob(svgEl, scale=2){
      const svgText = new XMLSerializer().serializeToString(svgEl);
      const svgBlob = new Blob([svgText], {type:"image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      await new Promise((resolve, reject)=>{
        img.onload = ()=>resolve();
        img.onerror = reject;
        img.src = url;
      });

      const canvas = document.createElement("canvas");
      canvas.width = Math.floor(img.width * scale);
      canvas.height = Math.floor(img.height * scale);
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      URL.revokeObjectURL(url);

      return new Promise((resolve)=>canvas.toBlob(resolve, "image/png", 0.95));
    }

    function buildTicketText(ticket){
      const pickText = ticket.picks.map((p,i)=>`${p.text}（${ticket.alloc[i].toLocaleString()}円）`).join(" / ");
      const url = location.href;
      const jockeyText = latestJockey ? `今日の推しジョッキー：${latestJockey.name}` : "";
      return [
        jockeyText,
        `馬券おみくじ：${ticket.typeLabel}`,
        `買い目：${pickText}`,
        `合計：${ticket.total.toLocaleString()}円`,
        url,
        "#馬券おみくじ #今日の推しジョッキー"
      ].filter(Boolean).join("\n");
    }

    const VENUES2 = VENUES; // alias

    bakenBtn.addEventListener("click", async ()=>{
      ticketErr.style.display = "none";
      ticketErr.textContent = "";

      const typeLabel = betTypeEl.value;
      const fieldSize = clampInt(fieldSizeEl.value, 2, 18);
      fieldSizeEl.value = fieldSize;

      const points = clampInt(pointsEl.value, 1, 10);
      const budget = clampInt(budgetEl.value, 100, 99999999);
      const { total, alloc } = allocateBudget(budget, points);

      const venue = pickOne(VENUES2);
      const raceNo = clampInt(Math.floor(Math.random()*12)+1, 1, 12);

      const picks = [];
      const used = new Set();
      let guard = 0;
      while(picks.length < points && guard < 250){
        const p = makePick(typeLabel, fieldSize);
        const key = p.text;
        if(!used.has(key)){
          used.add(key);
          picks.push(p);
        }
        guard++;
      }
      while(picks.length < points){
        picks.push(makePick(typeLabel, fieldSize));
      }

      const fortune = randomFortune();
      latestTicket = { venue, raceNo, typeLabel, fieldSize, points, picks, alloc, total, fortune };
      renderTicket(latestTicket);
    });

    shareTicketLink.addEventListener("click", async (e)=>{
      e.preventDefault();
      if(!latestTicket){
        alert("先に馬券おみくじを引いてください。");
        return;
      }
      const text = buildTicketText(latestTicket);

      const svgEl = ticketSvgHolder.querySelector("svg");
      if(svgEl && navigator.canShare){
        try{
          const blob = await svgToPngBlob(svgEl, 2);
          if(blob){
            const file = new File([blob], "baken.png", { type: "image/png" });
            if(navigator.canShare({ files: [file] }) && navigator.share){
              await navigator.share({ text, files:[file] });
              return;
            }
          }
        }catch(e){}
      }
      await shareCommon(text);
    });
  </script>
</body>
</html>
