<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>今日の推しジョッキー</title>

  <!-- 筆文字フォント -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Yuji+Boku&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#171717;
      --paper:#fbf7ee;
      --paper2:#f2ead7;
      --line:#d9cdb5;
      --seal:#b00020;
      --indigo:#1a4aa5;
      --shadow: rgba(0,0,0,.08);
      --card: rgba(255,255,255,.60);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:18px;
      color:var(--ink);
      background:
        radial-gradient(1100px 900px at 15% 10%, rgba(0,0,0,.05), transparent 60%),
        radial-gradient(900px 800px at 85% 0%, rgba(0,0,0,.035), transparent 55%),
        linear-gradient(180deg, var(--paper), var(--paper2));
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:
        repeating-linear-gradient(0deg, rgba(0,0,0,.016) 0, rgba(0,0,0,.016) 1px, transparent 1px, transparent 4px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.012) 0, rgba(0,0,0,.012) 1px, transparent 1px, transparent 5px);
      mix-blend-mode:multiply;
      opacity:.32;
    }

    .wrap{max-width:980px;margin:0 auto}
    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width:860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .shrine{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.55);
      box-shadow: 0 12px 32px var(--shadow);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .seal{
      position:absolute;
      right:16px;
      top:14px;
      width:64px;height:64px;
      border:2px solid rgba(176,0,32,.65);
      color:rgba(176,0,32,.8);
      border-radius:10px;
      display:grid;
      place-items:center;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:26px;
      transform:rotate(9deg);
      background:rgba(255,255,255,.18);
      user-select:none;
    }

    .title{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:34px;
      letter-spacing:.08em;
      margin:0;
      line-height:1.15;
      padding-right:78px;
    }
    .hint{
      margin:8px 0 0;
      color:#444;
      font-size:12px;
      line-height:1.6;
    }

    .btnrow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:14px;
    }
    .btn{
      border:1px solid #cbbd9f;
      background:linear-gradient(180deg, #fffdf7, #f3ead6);
      color:var(--ink);
      border-radius:14px;
      padding:12px 18px;
      cursor:pointer;
      box-shadow: 0 6px 16px var(--shadow);
      transition: transform .08s ease, box-shadow .08s ease, opacity .08s ease;
      font-size:16px;
    }
    .btn:active{transform:translateY(1px);box-shadow: 0 4px 12px var(--shadow)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn.main{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:22px;
      letter-spacing:.18em;
      padding:14px 22px;
      border-color:#b9a27a;
    }
    .btn.share{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      letter-spacing:.08em;
    }

    /* 推しジョッキー結果（縦書き） */
    .omikuji{
      margin-top:16px;
      display:none;
      border:1px solid var(--line);
      border-radius:18px;
      background:var(--card);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .omikuji::before{
      content:"";
      position:absolute;
      left:16px; right:16px; top:10px;
      height:1px;
      background:linear-gradient(90deg, transparent, rgba(0,0,0,.12), transparent);
      opacity:.75;
    }
    .omikujiInner{
      display:flex;
      gap:16px;
      align-items:stretch;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .vertical{
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:28px;
      letter-spacing:.18em;
      line-height:1.25;
      padding:10px 6px;
      min-height:220px;
      border-right:1px dashed rgba(0,0,0,.12);
    }
    .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      justify-content:flex-start;
      min-width:240px;
      flex:1;
      padding-top:6px;
    }
    .link{
      display:inline-block;
      color:var(--indigo);
      text-decoration:underline;
      text-underline-offset:3px;
      word-break:break-all;
      font-size:15px;
    }
    .small{
      color:#444;
      font-size:12px;
      line-height:1.6;
    }
    .err{
      margin-top:10px;
      white-space:pre-wrap;
      color:var(--seal);
      font-size:13px;
      display:none;
    }

    /* 馬券おみくじ UI */
    .sectionTitle{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:22px;
      letter-spacing:.10em;
      margin:0 0 10px;
      padding-right:78px;
    }
    .formRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-top:12px;
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      color:#333;
      min-width:180px;
    }
    select, input{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.82);
      font-size:14px;
      outline:none;
    }
    input{width:140px}

    /* ★馬券“画像”枠（SVGを入れる） */
    .ticketWrap{
      margin-top:14px;
      display:none;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.66);
      overflow:hidden;
      box-shadow: 0 10px 26px var(--shadow);
    }
    .ticketSvg{
      width:100%;
      height:auto;
      display:block;
      background:#fff;
    }
    .ticketBottomRow{
      padding:12px 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      background:rgba(255,255,255,.45);
      border-top:1px dashed rgba(0,0,0,.10);
    }
    .yen{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:14px;
      letter-spacing:.06em;
    }
    .stamp{
      display:inline-grid;
      place-items:center;
      width:54px;height:54px;
      border-radius:10px;
      border:2px solid rgba(176,0,32,.65);
      color:rgba(176,0,32,.8);
      font-family:"Yuji Syuku","Yuji Boku",serif;
      transform:rotate(-8deg);
      background:rgba(255,255,255,.20);
      user-select:none;
    }

    .footer{
      margin-top:14px;
      padding:14px 16px;
      border:1px dashed #cbbd9f;
      border-radius:16px;
      background:rgba(255,255,255,.45);
    }
    .footer h2{
      margin:0 0 8px;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:18px;
      letter-spacing:.08em;
    }
    .footlink{
      color:var(--indigo);
      text-decoration:underline;
      text-underline-offset:3px;
      word-break:break-all;
      font-size:13px;
    }

    @media (max-width:520px){
      .title{font-size:32px}
      .vertical{font-size:24px; min-height:190px;}
      .actions{min-width:unset}
      label{min-width:unset}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="grid">

      <!-- 推しジョッキー（カードで囲い） -->
      <div class="shrine">
        <div class="seal">推</div>

        <h1 class="title">今日の推しジョッキー</h1>
        <p class="hint">神社のおみくじ風に、今日の推しを授かります。</p>

        <div class="btnrow">
          <button id="drawBtn" class="btn main" type="button">勝負！</button>
          <button id="shareBtn" class="btn share" type="button" disabled>シェア</button>
        </div>

        <div class="omikuji" id="result">
          <div class="omikujiInner">
            <div class="vertical" id="name">（表示）</div>

            <div class="actions">
              <a id="profileLink" class="link" href="#" target="_blank" rel="noopener noreferrer">プロフィールを見る</a>
              <div class="small">
                ※リンク先はUMAJOの個別プロフィールです。<br>
                ※開けない場合は時間をおいて再度お試しください。
              </div>

              <div id="meta" style="display:none;"></div>
              <div class="err" id="err"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 馬券おみくじ -->
      <div class="shrine">
        <div class="seal">券</div>

        <h2 class="sectionTitle">馬券おみくじ</h2>
        <div class="small">種類・頭数・点数・合計金額を選んで、「このレースのオススメ馬券」を引きます（ランダム）。</div>

        <div class="formRow">
          <label>
            勝馬投票券
            <select id="betType">
              <option value="win">単勝</option>
              <option value="place">複勝</option>
              <option value="wakuren">枠連</option>
              <option value="umaren">馬連</option>
              <option value="wide">ワイド</option>
              <option value="umatan">馬単</option>
              <option value="trio">3連複</option>
              <option value="trifecta">3連単</option>
            </select>
          </label>

          <label>
            レース頭数（2〜18）
            <input id="fieldSize" type="number" min="2" max="18" value="12" />
          </label>

          <label>
            点数
            <select id="ticketPoints">
              <option value="1">1点</option>
              <option value="3">3点</option>
              <option value="5">5点</option>
            </select>
          </label>

          <label>
            合計金額（円）
            <input id="budget" type="number" min="100" step="100" value="1000" />
          </label>

          <button id="ticketBtn" class="btn main" type="button">馬券おみくじ</button>
        </div>

        <!-- ★ここが“馬券画像”になります -->
        <div class="ticketWrap" id="ticketWrap">
          <div id="ticketSvgMount"></div>
          <div class="ticketBottomRow">
            <div class="yen" id="ticketAmount">合計：1000円</div>
            <div class="stamp" id="ticketFortune">吉</div>
          </div>
        </div>

        <a id="ticketShareLink" class="link" href="#" style="display:none;margin-top:10px;">この馬券をシェア</a>
        <div class="err" id="ticketErr"></div>
      </div>

    </div>

    <div class="footer">
      <h2>おすすめサイト</h2>
      <a class="footlink"
         href="https://c-lemaire.co.jp/?srsltid=AfmBOop6TBukVoj2Y2Cs9SYRuY_8TsMUwtuXH3sUJPnIAXSxN-VKYrgq"
         target="_blank" rel="noopener noreferrer">
        https://c-lemaire.co.jp/
      </a>
    </div>
  </div>

  <script>
    // ====== 推しジョッキー ======
    const drawBtn  = document.getElementById("drawBtn");
    const shareBtn = document.getElementById("shareBtn");
    const resultEl = document.getElementById("result");
    const nameEl   = document.getElementById("name");
    const linkEl   = document.getElementById("profileLink");
    const errEl    = document.getElementById("err");

    let lastPicked = null;
    let lastTicket = null;

    function setShareEnabled(){
      shareBtn.disabled = !(lastPicked || lastTicket);
    }

    function showError(msg){
      resultEl.style.display = "block";
      errEl.style.display = "block";
      errEl.textContent = msg;
    }
    function clearError(){
      errEl.style.display = "none";
      errEl.textContent = "";
    }

    async function draw(){
      drawBtn.disabled = true;
      drawBtn.textContent = "神託中…";
      clearError();

      try{
        const res = await fetch("/api/oshi-jockey", { cache: "no-store" });
        const text = await res.text();
        let data;
        try{ data = JSON.parse(text); }
        catch{ throw new Error("APIの応答がJSONではありませんでした。時間をおいて再度お試しください。"); }

        if(!res.ok || data.error){
          throw new Error(data.message || `API error: ${res.status}`);
        }

        const picked = data.picked || {};
        const name = picked.name || "(ジョッキー)";
        const profileUrl = picked.profileUrl;
        if(!profileUrl) throw new Error("APIの返却に profileUrl がありません。");

        lastPicked = { name, profileUrl };
        nameEl.textContent = name;

        linkEl.href = profileUrl;
        linkEl.target = "_blank";
        linkEl.rel = "noopener noreferrer";

        resultEl.style.display = "block";
        setShareEnabled();

      }catch(e){
        console.error(e);
        lastPicked = null;
        setShareEnabled();
        showError("取得に失敗しました。\n\n" + String(e.message || e));
      }finally{
        drawBtn.disabled = false;
        drawBtn.textContent = "勝負！";
      }
    }

    function buildShareText(){
      const parts = [];
      let url = location.href;

      if(lastPicked){
        parts.push(`今日の推しジョッキーは「${lastPicked.name}」！`);
        url = lastPicked.profileUrl || url;
      }
      if(lastTicket){
        parts.push(`馬券おみくじ：${lastTicket.typeLabel} / ${lastTicket.linesText}（合計${lastTicket.total}円）`);
      }
      return { text: parts.join("\n"), url };
    }

    async function share(){
      if(!(lastPicked || lastTicket)) return;
      const { text, url } = buildShareText();

      if(navigator.share){
        try{
          await navigator.share({ title:"今日の推しジョッキー", text, url });
          return;
        }catch(_){}
      }
      const xUrl = `https://x.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
      window.open(xUrl, "_blank", "noopener,noreferrer");
    }

    drawBtn.addEventListener("click", draw);
    shareBtn.addEventListener("click", share);

    // ====== 馬券おみくじ（A→C→B） ======
    const betTypeEl = document.getElementById("betType");
    const fieldSizeEl = document.getElementById("fieldSize");
    const ticketBtn = document.getElementById("ticketBtn");
    const pointsEl = document.getElementById("ticketPoints");
    const budgetEl = document.getElementById("budget");

    const ticketWrapEl = document.getElementById("ticketWrap");
    const ticketSvgMount = document.getElementById("ticketSvgMount");
    const ticketAmountEl = document.getElementById("ticketAmount");
    const ticketFortuneEl = document.getElementById("ticketFortune");
    const ticketErrEl = document.getElementById("ticketErr");
    const ticketShareLinkEl = document.getElementById("ticketShareLink");

    const typeLabels = {
      win: "単勝",
      place: "複勝",
      wakuren: "枠連",
      umaren: "馬連",
      wide: "ワイド",
      umatan: "馬単",
      trio: "3連複",
      trifecta: "3連単",
    };

    function randInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function sampleUniqueNumbers(count, min, max){
      const set = new Set();
      while(set.size < count){
        set.add(randInt(min, max));
      }
      return [...set];
    }
    function sortAsc(arr){ return [...arr].sort((a,b)=>a-b); }

    function frameOfHorse(horseNo, fieldSize){
      const frames = 8;
      const idx = Math.floor((horseNo - 1) * frames / fieldSize) + 1;
      return Math.min(frames, Math.max(1, idx));
    }

    function buildPick(type, fieldSize){
      if(type === "win"){
        const a = randInt(1, fieldSize);
        return { raw: [a], text: `馬番 ${a}`, hint: "単勝：1頭" };
      }
      if(type === "place"){
        const a = randInt(1, fieldSize);
        return { raw: [a], text: `馬番 ${a}`, hint: "複勝：1頭" };
      }
      if(type === "umaren"){
        const [a,b] = sortAsc(sampleUniqueNumbers(2, 1, fieldSize));
        return { raw: [a,b], text: `馬番 ${a}-${b}`, hint: "馬連：2頭（順不同）" };
      }
      if(type === "wide"){
        const [a,b] = sortAsc(sampleUniqueNumbers(2, 1, fieldSize));
        return { raw: [a,b], text: `馬番 ${a}-${b}`, hint: "ワイド：2頭（順不同）" };
      }
      if(type === "umatan"){
        const [a,b] = sampleUniqueNumbers(2, 1, fieldSize);
        return { raw: [a,b], text: `馬番 ${a}→${b}`, hint: "馬単：2頭（順序あり）" };
      }
      if(type === "trio"){
        const [a,b,c] = sortAsc(sampleUniqueNumbers(3, 1, fieldSize));
        return { raw: [a,b,c], text: `馬番 ${a}-${b}-${c}`, hint: "3連複：3頭（順不同）" };
      }
      if(type === "trifecta"){
        const [a,b,c] = sampleUniqueNumbers(3, 1, fieldSize);
        return { raw: [a,b,c], text: `馬番 ${a}→${b}→${c}`, hint: "3連単：3頭（順序あり）" };
      }
      if(type === "wakuren"){
        const [h1,h2] = sortAsc(sampleUniqueNumbers(2, 1, fieldSize));
        const f1 = frameOfHorse(h1, fieldSize);
        const f2 = frameOfHorse(h2, fieldSize);
        const [a,b] = sortAsc([f1,f2]);
        return { raw: [a,b], text: `枠 ${a}-${b}`, hint: "枠連：2枠（順不同）" };
      }
      return { raw: [], text: "-", hint: "" };
    }

    function normalizePick(type, text){
      return `${type}:${text}`.replace(/\s+/g,"").trim();
    }

    function showTicketError(msg){
      ticketErrEl.style.display = "block";
      ticketErrEl.textContent = msg;
    }
    function clearTicketError(){
      ticketErrEl.style.display = "none";
      ticketErrEl.textContent = "";
    }

    function updatePointsOptions(){
      const type = betTypeEl.value;
      const fixed1 = (type === "win" || type === "place");
      const current = pointsEl.value;

      pointsEl.innerHTML = "";
      pointsEl.appendChild(new Option("1点", "1"));
      if(!fixed1) pointsEl.appendChild(new Option("3点", "3"));
      if(!fixed1) pointsEl.appendChild(new Option("5点", "5"));

      const values = [...pointsEl.options].map(o=>o.value);
      pointsEl.value = values.includes(current) ? current : "1";
      pointsEl.disabled = fixed1;
    }

    function splitBudget(total, points){
      const base = Math.floor(total / points / 100) * 100;
      let used = base * points;
      let rem = total - used;

      const arr = new Array(points).fill(base);
      let i = 0;
      while(rem >= 100 && i < arr.length){
        arr[i] += 100;
        rem -= 100;
        i++;
      }
      if(rem > 0) arr[arr.length - 1] += rem;
      return arr;
    }

    function fortuneByTotal(total){
      const pool = ["大吉","中吉","吉","小吉","末吉"];
      const bias = total >= 1000 ? ["大吉","中吉"] : [];
      const pick = pool.concat(bias);
      return pick[randInt(0, pick.length - 1)];
    }

    // ====== ★ここがメイン：馬券“画像”をSVGで生成（枠に数字・枠に式別） ======
    function makeTicketSVG({ venue, raceNo, typeLabel, fieldSize, points, picks, alloc, total }){
      const W = 980, H = 420;

      const codeMap = {
        "単勝":"WIN", "複勝":"PLC", "枠連":"WAK", "馬連":"UMR",
        "ワイド":"WID", "馬単":"UMT", "3連複":"TRI", "3連単":"TRF"
      };
      const betCode = codeMap[typeLabel] || "BET";

      const lines = picks.map((p, i) => ({
        raw: p.raw || [],
        text: p.text || "",
        yen: `${alloc[i].toLocaleString()}円`,
      }));

      const pad2 = (n) => String(n).padStart(2,"0");

      const kind = (() => {
        if (typeLabel === "馬単" || typeLabel === "3連単") return "arrow";
        return "dash";
      })();

      function boxesSvg(rawNums, x, y){
        const boxW = 58, boxH = 58, gap = 14;
        const stroke = 3;

        const sep = () => {
          if (rawNums.length === 1) return "";
          if (kind === "arrow") return "→";
          return "−";
        };

        const sepX = (i) => x + (boxW + gap) * i + boxW + 10;

        let out = "";

        for (let i=0; i<rawNums.length; i++){
          const bx = x + (boxW + gap) * i + (i>0 ? 18*i : 0);
          out += `
            <rect x="${bx}" y="${y}" width="${boxW}" height="${boxH}" rx="10"
                  fill="#fff" stroke="#111" stroke-width="${stroke}"/>
            <text x="${bx + boxW/2}" y="${y + 40}" font-size="28" font-weight="900"
                  text-anchor="middle"
                  font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace">
              ${pad2(rawNums[i])}
            </text>
          `;

          if (i < rawNums.length - 1){
            const s = sep();
            out += `
              <text x="${sepX(i)}" y="${y + 41}" font-size="30" font-weight="900"
                    text-anchor="middle"
                    font-family="system-ui, -apple-system, 'Noto Sans JP', sans-serif">
                ${s}
              </text>
            `;
          }
        }
        return out;
      }

      const watermark = `
        <g opacity="0.08">
          <circle cx="720" cy="140" r="120" fill="#1a4aa5"/>
          <circle cx="840" cy="260" r="140" fill="#b00020"/>
        </g>
      `;

      const stripes = `
        <defs>
          <pattern id="stripes" width="14" height="14" patternUnits="userSpaceOnUse">
            <rect width="14" height="14" fill="#f7fbf7"/>
            <rect width="7" height="14" fill="#e7f6ef"/>
          </pattern>
        </defs>
        <rect x="0" y="0" width="${W}" height="${H}" fill="url(#stripes)"/>
      `;

      const qr = `
        <g transform="translate(28,98)">
          <rect x="0" y="0" width="160" height="160" rx="10" fill="#fff" stroke="#111" opacity="0.9"/>
          ${Array.from({length:10}).map((_,r)=>
            Array.from({length:10}).map((__,c)=>{
              const on = (r*c + r + c) % 3 === 0;
              return on ? `<rect x="${10+c*14}" y="${10+r*14}" width="10" height="10" fill="#111" opacity="0.65"/>` : "";
            }).join("")
          ).join("")}
        </g>
      `;

      const left = `
        <g font-family="system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif" fill="#111">
          <text x="30" y="48" font-size="44" font-weight="900">${venue}</text>
          <text x="205" y="48" font-size="28" font-weight="700">（日）</text>

          <rect x="30" y="70" width="110" height="82" rx="10" fill="#111"/>
          <text x="85" y="124" font-size="50" font-weight="900" fill="#fff" text-anchor="middle">${raceNo}</text>
          <text x="160" y="124" font-size="34" font-weight="900">レース</text>

          ${qr}

          <text x="30" y="370" font-size="22" opacity="0.85">頭数：${fieldSize} / 点数：${points}</text>
        </g>
      `;

      const typeVertical = typeLabel.split("").join("\n");
      const center = `
        <g>
          <rect x="380" y="40" width="120" height="340" fill="#fff" stroke="#111" stroke-width="5"/>
          <text x="440" y="85" font-size="22" font-weight="900" text-anchor="middle" opacity="0.85">${betCode}</text>

          <text x="440" y="210" font-size="66" font-weight="900" text-anchor="middle"
                style="white-space:pre; font-family: system-ui, -apple-system, 'Noto Sans JP', sans-serif;">
            ${typeVertical}
          </text>

          <text x="440" y="350" font-size="22" font-weight="900" text-anchor="middle" opacity="0.85">${betCode}</text>
        </g>
      `;

      const right = `
        <g font-family="system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif" fill="#111">
          ${lines.map((ln, idx)=>{
            const y = 92 + idx*86;
            const buyX = 545;

            let raw = ln.raw;
            if (!raw || raw.length === 0){
              const nums = (ln.text.match(/\d+/g) || []).map(n=>Number(n)).slice(0,3);
              raw = nums;
            }

            return `
              <g>
                ${boxesSvg(raw, buyX, y)}

                <rect x="820" y="${y}" width="140" height="58" rx="10"
                      fill="#fff" stroke="#111" stroke-width="3"/>
                <text x="890" y="${y+40}" font-size="26" font-weight="900" text-anchor="middle"
                      font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace">
                  × ${ln.yen}
                </text>
              </g>
            `;
          }).join("")}

          <text x="545" y="388" font-size="26" font-weight="900">合計</text>
          <text x="630" y="388" font-size="46" font-weight="900"
                font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace">
            ${total.toLocaleString()}円
          </text>
        </g>
      `;

      const frame = `<rect x="6" y="6" width="${W-12}" height="${H-12}" rx="18" fill="none" stroke="#111" stroke-width="6"/>`;

      return `
        <svg class="ticketSvg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="馬券">
          ${stripes}
          ${watermark}
          ${left}
          ${center}
          ${right}
          ${frame}
        </svg>
      `;
    }

    function drawTicket(){
      clearTicketError();

      const type = betTypeEl.value;
      const fieldSize = Number(fieldSizeEl.value);
      const points = Number(pointsEl.value || "1");
      const budget = Number(budgetEl.value);

      if(!Number.isFinite(fieldSize) || fieldSize < 2 || fieldSize > 18){
        showTicketError("レース頭数は 2〜18 の範囲で入力してください。");
        return;
      }
      if(!Number.isFinite(budget) || budget < 100){
        showTicketError("合計金額は 100円以上で入力してください。");
        return;
      }

      const fixed1 = (type === "win" || type === "place");
      const finalPoints = fixed1 ? 1 : points;

      const set = new Set();
      const picks = [];
      const maxTry = 80;

      for(let t=0; t<maxTry && picks.length < finalPoints; t++){
        const p = buildPick(type, fieldSize);
        const key = normalizePick(type, p.text);
        if(set.has(key)) continue;
        set.add(key);
        picks.push(p);
      }
      if(picks.length < finalPoints){
        showTicketError("買い目の生成に失敗しました。時間をおいて再度お試しください。");
        return;
      }

      const alloc = splitBudget(budget, finalPoints);

      const venue = ["阪神","京都","東京","中山","札幌","函館","新潟","中京","小倉"][randInt(0,8)];
      const raceNo = randInt(1, 12);
      const typeLabel = typeLabels[type] || "馬券";

      ticketSvgMount.innerHTML = makeTicketSVG({
        venue, raceNo, typeLabel,
        fieldSize, points: finalPoints,
        picks, alloc, total: budget
      });

      ticketWrapEl.style.display = "block";
      ticketAmountEl.textContent = `合計：${budget.toLocaleString()}円`;
      ticketFortuneEl.textContent = fortuneByTotal(budget);

      const linesText = picks.map((p,i)=>`${p.text.replace("馬番 ","").replace("枠 ","枠 ")}×${alloc[i]}円`).join(" / ");
      lastTicket = { typeLabel, linesText, total: budget };
      setShareEnabled();

      ticketShareLinkEl.style.display = "inline-block";
      ticketShareLinkEl.onclick = (e)=>{ e.preventDefault(); share(); };
    }

    betTypeEl.addEventListener("change", updatePointsOptions);
    updatePointsOptions();
    ticketBtn.addEventListener("click", drawTicket);

    setShareEnabled();
  </script>
</body>
</html>
