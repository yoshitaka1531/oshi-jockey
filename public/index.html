<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>今日の推しジョッキー</title>

  <!-- 筆文字フォント -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Yuji+Boku&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#171717;
      --paper:#fbf7ee;
      --paper2:#f2ead7;
      --line:#d9cdb5;
      --seal:#b00020;
      --indigo:#1a4aa5;
      --shadow: rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:22px;
      color:var(--ink);
      background:
        radial-gradient(1100px 900px at 15% 10%, rgba(0,0,0,.05), transparent 60%),
        radial-gradient(900px 800px at 85% 0%, rgba(0,0,0,.035), transparent 55%),
        linear-gradient(180deg, var(--paper), var(--paper2));
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
    }
    /* 和紙っぽい質感 */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:
        repeating-linear-gradient(0deg, rgba(0,0,0,.016) 0, rgba(0,0,0,.016) 1px, transparent 1px, transparent 4px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.012) 0, rgba(0,0,0,.012) 1px, transparent 1px, transparent 5px);
      mix-blend-mode:multiply;
      opacity:.35;
    }

    .wrap{max-width:980px;margin:0 auto}
    .top{
      display:flex;
      gap:18px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:38px;
      letter-spacing:.08em;
      margin:0;
      line-height:1.1;
    }
    .hint{
      margin:6px 0 0;
      color:#444;
      font-size:12px;
    }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width:860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    /* おみくじ台 */
    .shrine{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.55);
      box-shadow: 0 12px 32px var(--shadow);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .seal{
      position:absolute;
      right:16px;
      top:14px;
      width:64px;height:64px;
      border:2px solid rgba(176,0,32,.65);
      color:rgba(176,0,32,.8);
      border-radius:10px;
      display:grid;
      place-items:center;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:26px;
      transform:rotate(9deg);
      background:rgba(255,255,255,.18);
      user-select:none;
    }

    .btnrow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border:1px solid #cbbd9f;
      background:linear-gradient(180deg, #fffdf7, #f3ead6);
      color:var(--ink);
      border-radius:14px;
      padding:12px 18px;
      cursor:pointer;
      box-shadow: 0 6px 16px var(--shadow);
      transition: transform .08s ease, box-shadow .08s ease, opacity .08s ease;
      font-size:16px;
    }
    .btn:active{transform:translateY(1px);box-shadow: 0 4px 12px var(--shadow)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn.main{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:22px;
      letter-spacing:.18em;
      padding:14px 22px;
      border-color:#b9a27a;
    }
    .btn.share{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      letter-spacing:.08em;
    }

    /* 結果（縦書き） */
    .omikuji{
      margin-top:16px;
      display:none;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.62);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .omikuji::before{
      content:"";
      position:absolute;
      left:16px; right:16px; top:10px;
      height:1px;
      background:linear-gradient(90deg, transparent, rgba(0,0,0,.12), transparent);
      opacity:.75;
    }
    .omikujiInner{
      display:flex;
      gap:16px;
      align-items:stretch;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .vertical{
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:28px;
      letter-spacing:.18em;
      line-height:1.25;
      padding:10px 6px;
      min-height:220px;
      border-right:1px dashed rgba(0,0,0,.12);
    }
    .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      justify-content:flex-start;
      min-width:240px;
      flex:1;
      padding-top:6px;
    }
    .link{
      display:inline-block;
      color:var(--indigo);
      text-decoration:underline;
      text-underline-offset:3px;
      word-break:break-all;
      font-size:15px;
    }
    .small{
      color:#444;
      font-size:12px;
      line-height:1.6;
    }
    .err{
      margin-top:10px;
      white-space:pre-wrap;
      color:var(--seal);
      font-size:13px;
      display:none;
    }

    /* 馬券おみくじ：設定欄 */
    .sectionTitle{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:22px;
      letter-spacing:.10em;
      margin:0 0 10px;
    }
    .formRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-top:10px;
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      color:#333;
      min-width:180px;
    }
    select, input{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.8);
      font-size:14px;
      outline:none;
    }
    input{width:140px}

    /* 馬券っぽいカード（オリジナルデザイン） */
    .ticket{
      margin-top:14px;
      display:none;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.65);
      overflow:hidden;
      box-shadow: 0 10px 26px var(--shadow);
    }
    .ticketTop{
      display:flex;
      gap:12px;
      align-items:stretch;
      padding:14px;
      border-bottom:1px dashed rgba(0,0,0,.12);
      position:relative;
    }
    .ticketTop::after{
      content:"";
      position:absolute;
      right:-60px; top:-80px;
      width:220px; height:220px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(26,74,165,.12), transparent 60%);
      transform:rotate(12deg);
      pointer-events:none;
    }
    .ticketType{
      min-width:66px;
      border:1px solid rgba(0,0,0,.18);
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 6px;
      background:rgba(0,0,0,.04);
      font-family:"Yuji Syuku","Yuji Boku",serif;
      letter-spacing:.1em;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size:18px;
    }
    .ticketBody{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .ticketLine{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .chip{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.18);
      background:rgba(255,255,255,.75);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing:.08em;
      font-size:14px;
    }
    .ticketHint{
      font-size:12px;
      color:#444;
      line-height:1.6;
    }
    .ticketBottom{
      padding:12px 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .yen{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:14px;
      letter-spacing:.06em;
    }
    .stamp{
      display:inline-grid;
      place-items:center;
      width:54px;height:54px;
      border-radius:10px;
      border:2px solid rgba(176,0,32,.65);
      color:rgba(176,0,32,.8);
      font-family:"Yuji Syuku","Yuji Boku",serif;
      transform:rotate(-8deg);
      background:rgba(255,255,255,.20);
      user-select:none;
    }

    .footer{
      margin-top:14px;
      padding:14px 16px;
      border:1px dashed #cbbd9f;
      border-radius:16px;
      background:rgba(255,255,255,.45);
    }
    .footer h2{
      margin:0 0 8px;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:18px;
      letter-spacing:.08em;
    }
    .footlink{
      color:var(--indigo);
      text-decoration:underline;
      text-underline-offset:3px;
      word-break:break-all;
      font-size:13px;
    }

    @media (max-width:520px){
      .title{font-size:34px}
      .vertical{font-size:24px; min-height:190px;}
      .actions{min-width:unset}
      label{min-width:unset}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 class="title">今日の推しジョッキー</h1>
        <p class="hint">神社のおみくじ風に、今日の推しを授かります。</p>
      </div>
    </div>

    <div class="grid">
      <!-- ジョッキーおみくじ -->
      <div class="shrine">
        <div class="seal">推</div>

        <div class="btnrow">
          <!-- ★IDは維持（壊れないため） -->
          <button id="drawBtn" class="btn main" type="button">勝負！</button>
          <button id="shareBtn" class="btn share" type="button" disabled>シェア</button>
        </div>

        <div class="omikuji" id="result">
          <div class="omikujiInner">
            <div class="vertical" id="name">（表示）</div>

            <div class="actions">
              <a id="profileLink" class="link" href="#" target="_blank" rel="noopener noreferrer">プロフィールを見る</a>
              <div class="small">
                ※リンク先はUMAJOの個別プロフィールです。<br>
                ※開けない場合は時間をおいて再度お試しください。
              </div>

              <!-- 候補数表示は出さない -->
              <div id="meta" style="display:none;"></div>

              <div class="err" id="err"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 馬券おみくじ -->
      <div class="shrine">
        <div class="seal">券</div>

        <h2 class="sectionTitle">馬券おみくじ</h2>
        <div class="small">勝馬投票券の種類と頭数を選んで、「このレースのオススメ馬券」を引きます（ランダム）。</div>

        <div class="formRow">
          <label>
            勝馬投票券
            <select id="betType">
              <option value="win">単勝</option>
              <option value="place">複勝</option>
              <option value="wakuren">枠連</option>
              <option value="umaren">馬連</option>
              <option value="wide">ワイド</option>
              <option value="umatan">馬単</option>
              <option value="trio">3連複</option>
              <option value="trifecta">3連単</option>
            </select>
          </label>

          <label>
            レース頭数（2〜18）
            <input id="fieldSize" type="number" min="2" max="18" value="12" />
          </label>

          <button id="ticketBtn" class="btn main" type="button">馬券おみくじ</button>
        </div>

        <div class="ticket" id="ticket">
          <div class="ticketTop">
            <div class="ticketType" id="ticketTypeLabel">単勝</div>
            <div class="ticketBody">
              <div class="ticketLine">
                <span class="chip" id="ticketPick">-</span>
              </div>
              <div class="ticketHint" id="ticketHint">
                ※本機能はランダム生成です。実際の購入判断はご自身の責任でお願いいたします。
              </div>
            </div>
          </div>
          <div class="ticketBottom">
            <div class="yen" id="ticketAmount">購入目安：100円</div>
            <div class="stamp">吉</div>
          </div>
        </div>

        <div class="err" id="ticketErr"></div>
      </div>
    </div>

    <!-- おすすめサイト（最下部） -->
    <div class="footer">
      <h2>おすすめサイト</h2>
      <a class="footlink"
         href="https://c-lemaire.co.jp/?srsltid=AfmBOop6TBukVoj2Y2Cs9SYRuY_8TsMUwtuXH3sUJPnIAXSxN-VKYrgq"
         target="_blank" rel="noopener noreferrer">
        https://c-lemaire.co.jp/
      </a>
    </div>
  </div>

  <script>
    // ====== 既存：ジョッキーおみくじ（壊さない） ======
    const drawBtn  = document.getElementById("drawBtn");
    const shareBtn = document.getElementById("shareBtn");
    const resultEl = document.getElementById("result");
    const nameEl   = document.getElementById("name");
    const linkEl   = document.getElementById("profileLink");
    const errEl    = document.getElementById("err");

    let lastPicked = null;

    function showError(msg){
      resultEl.style.display = "block";
      errEl.style.display = "block";
      errEl.textContent = msg;
    }
    function clearError(){
      errEl.style.display = "none";
      errEl.textContent = "";
    }

    async function draw(){
      drawBtn.disabled = true;
      shareBtn.disabled = true;
      drawBtn.textContent = "神託中…";
      clearError();

      try{
        const res = await fetch("/api/oshi-jockey", { cache: "no-store" });
        const text = await res.text();
        let data;
        try{ data = JSON.parse(text); }
        catch{ throw new Error("APIの応答がJSONではありませんでした。時間をおいて再度お試しください。"); }

        if(!res.ok || data.error){
          throw new Error(data.message || `API error: ${res.status}`);
        }

        const picked = data.picked || {};
        const name = picked.name || "(ジョッキー)";
        const profileUrl = picked.profileUrl;
        if(!profileUrl) throw new Error("APIの返却に profileUrl がありません。");

        lastPicked = { name, profileUrl };
        nameEl.textContent = name;

        linkEl.href = profileUrl;
        linkEl.target = "_blank";
        linkEl.rel = "noopener noreferrer";

        resultEl.style.display = "block";
        shareBtn.disabled = false;

      }catch(e){
        console.error(e);
        lastPicked = null;
        showError("取得に失敗しました。\n\n" + String(e.message || e));
      }finally{
        drawBtn.disabled = false;
        drawBtn.textContent = "勝負！";
      }
    }

    async function share(){
      if(!lastPicked) return;

      const text = `今日の推しジョッキーは「${lastPicked.name}」！`;
      const url  = lastPicked.profileUrl;

      if(navigator.share){
        try{
          await navigator.share({ title:"今日の推しジョッキー", text, url });
          return;
        }catch(_){}
      }
      const xUrl = `https://x.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
      window.open(xUrl, "_blank", "noopener,noreferrer");
    }

    drawBtn.addEventListener("click", draw);
    shareBtn.addEventListener("click", share);

    // ====== 新規：馬券おみくじ（フロントのみ・安全） ======
    const betTypeEl = document.getElementById("betType");
    const fieldSizeEl = document.getElementById("fieldSize");
    const ticketBtn = document.getElementById("ticketBtn");

    const ticketEl = document.getElementById("ticket");
    const ticketTypeLabelEl = document.getElementById("ticketTypeLabel");
    const ticketPickEl = document.getElementById("ticketPick");
    const ticketAmountEl = document.getElementById("ticketAmount");
    const ticketHintEl = document.getElementById("ticketHint");
    const ticketErrEl = document.getElementById("ticketErr");

    const typeLabels = {
      win: "単勝",
      place: "複勝",
      wakuren: "枠連",
      umaren: "馬連",
      wide: "ワイド",
      umatan: "馬単",
      trio: "3連複",
      trifecta: "3連単",
    };

    function randInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function sampleUniqueNumbers(count, min, max){
      const set = new Set();
      while(set.size < count){
        set.add(randInt(min, max));
      }
      return [...set];
    }
    function sortAsc(arr){ return [...arr].sort((a,b)=>a-b); }

    // 枠（1〜8）に馬番（1〜N）をざっくり割り当て（均等寄せ）
    function frameOfHorse(horseNo, fieldSize){
      // 1..8 に丸める。頭数が少なくても枠は最大8扱い（雰囲気重視）
      const frames = 8;
      const idx = Math.floor((horseNo - 1) * frames / fieldSize) + 1;
      return Math.min(frames, Math.max(1, idx));
    }

    function buildPick(type, fieldSize){
      // 返り値：{ display: "…", hint: "…" }
      if(type === "win"){
        const a = randInt(1, fieldSize);
        return { display: `馬番 ${a}`, hint: "単勝：1頭" };
      }
      if(type === "place"){
        const a = randInt(1, fieldSize);
        return { display: `馬番 ${a}`, hint: "複勝：1頭" };
      }
      if(type === "umaren"){
        const [a,b] = sortAsc(sampleUniqueNumbers(2, 1, fieldSize));
        return { display: `馬番 ${a} - ${b}`, hint: "馬連：2頭（順不同）" };
      }
      if(type === "wide"){
        const [a,b] = sortAsc(sampleUniqueNumbers(2, 1, fieldSize));
        return { display: `馬番 ${a} - ${b}`, hint: "ワイド：2頭（順不同）" };
      }
      if(type === "umatan"){
        const [a,b] = sampleUniqueNumbers(2, 1, fieldSize);
        return { display: `馬番 ${a} → ${b}`, hint: "馬単：2頭（順序あり）" };
      }
      if(type === "trio"){
        const [a,b,c] = sortAsc(sampleUniqueNumbers(3, 1, fieldSize));
        return { display: `馬番 ${a} - ${b} - ${c}`, hint: "3連複：3頭（順不同）" };
      }
      if(type === "trifecta"){
        const [a,b,c] = sampleUniqueNumbers(3, 1, fieldSize);
        return { display: `馬番 ${a} → ${b} → ${c}`, hint: "3連単：3頭（順序あり）" };
      }
      if(type === "wakuren"){
        // 枠連：枠番号(1..8)を2つ（順不同）
        const [h1,h2] = sortAsc(sampleUniqueNumbers(2, 1, fieldSize));
        const f1 = frameOfHorse(h1, fieldSize);
        const f2 = frameOfHorse(h2, fieldSize);
        const [a,b] = sortAsc([f1,f2]);
        return { display: `枠 ${a} - ${b}`, hint: "枠連：2枠（順不同）" };
      }
      return { display: "-", hint: "" };
    }

    function pickAmount(type){
      // 目安：100円〜1000円（雰囲気）
      const base = [100, 200, 300, 500, 1000];
      // 連単系は少し高めが出やすい、くらいの重み
      const heavy = (type === "umatan" || type === "trifecta") ? [500, 1000, 1000] : [];
      const pool = base.concat(heavy);
      return pool[randInt(0, pool.length - 1)];
    }

    function showTicketError(msg){
      ticketErrEl.style.display = "block";
      ticketErrEl.textContent = msg;
    }
    function clearTicketError(){
      ticketErrEl.style.display = "none";
      ticketErrEl.textContent = "";
    }

    function drawTicket(){
      clearTicketError();

      const type = betTypeEl.value;
      const fieldSize = Number(fieldSizeEl.value);

      if(!Number.isFinite(fieldSize) || fieldSize < 2 || fieldSize > 18){
        showTicketError("レース頭数は 2〜18 の範囲で入力してください。");
        return;
      }

      const { display, hint } = buildPick(type, fieldSize);
      const amount = pickAmount(type);

      ticketTypeLabelEl.textContent = typeLabels[type] || "馬券";
      ticketPickEl.textContent = display;
      ticketAmountEl.textContent = `購入目安：${amount}円`;
      ticketHintEl.textContent = `※${hint} / 頭数 ${fieldSize}（ランダム生成）`;

      ticketEl.style.display = "block";
    }

    ticketBtn.addEventListener("click", drawTicket);
  </script>
</body>
</html>
