<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>今日の推しジョッキー</title>

  <!-- 筆文字フォント -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Yuji+Boku&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#171717;
      --paper:#fbf7ee;
      --paper2:#f2ead7;
      --line:#d9cdb5;
      --seal:#b00020;
      --indigo:#1a4aa5;
      --shadow: rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:22px;
      color:var(--ink);
      background:
        radial-gradient(1100px 900px at 15% 10%, rgba(0,0,0,.05), transparent 60%),
        radial-gradient(900px 800px at 85% 0%, rgba(0,0,0,.035), transparent 55%),
        linear-gradient(180deg, var(--paper), var(--paper2));
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
    }

    /* 和紙っぽい質感（CSSのみ） */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:
        repeating-linear-gradient(0deg, rgba(0,0,0,.016) 0, rgba(0,0,0,.016) 1px, transparent 1px, transparent 4px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.012) 0, rgba(0,0,0,.012) 1px, transparent 1px, transparent 5px);
      mix-blend-mode:multiply;
      opacity:.35;
    }

    .wrap{max-width:900px;margin:0 auto}
    .top{
      display:flex;
      gap:18px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:38px;
      letter-spacing:.08em;
      margin:0;
      line-height:1.1;
    }
    .hint{
      margin:6px 0 0;
      color:#444;
      font-size:12px;
    }

    /* おみくじ台 */
    .shrine{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.55);
      box-shadow: 0 12px 32px var(--shadow);
      padding:18px;
      position:relative;
      overflow:hidden;
    }

    /* 朱印風スタンプ */
    .seal{
      position:absolute;
      right:16px;
      top:14px;
      width:64px;height:64px;
      border:2px solid rgba(176,0,32,.65);
      color:rgba(176,0,32,.8);
      border-radius:10px;
      display:grid;
      place-items:center;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:26px;
      transform:rotate(9deg);
      background:rgba(255,255,255,.18);
      user-select:none;
    }

    .btnrow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* 札っぽいボタン */
    .btn{
      border:1px solid #cbbd9f;
      background:linear-gradient(180deg, #fffdf7, #f3ead6);
      color:var(--ink);
      border-radius:14px;
      padding:12px 18px;
      cursor:pointer;
      box-shadow: 0 6px 16px var(--shadow);
      transition: transform .08s ease, box-shadow .08s ease, opacity .08s ease;
      font-size:16px;
    }
    .btn:active{transform:translateY(1px);box-shadow: 0 4px 12px var(--shadow)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}

    .btn.main{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:22px;
      letter-spacing:.18em;
      padding:14px 22px;
      border-color:#b9a27a;
    }
    .btn.share{
      font-family:"Yuji Syuku","Yuji Boku",serif;
      letter-spacing:.08em;
    }

    /* おみくじ紙（縦書き） */
    .omikuji{
      margin-top:16px;
      display:none;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.62);
      padding:18px;
      position:relative;
      overflow:hidden;
    }

    /* 紙の上部に“紐”っぽい装飾 */
    .omikuji::before{
      content:"";
      position:absolute;
      left:16px; right:16px; top:10px;
      height:1px;
      background:linear-gradient(90deg, transparent, rgba(0,0,0,.12), transparent);
      opacity:.75;
    }

    .omikujiInner{
      display:flex;
      gap:16px;
      align-items:stretch;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    /* 縦書き本体 */
    .vertical{
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:28px;
      letter-spacing:.18em;
      line-height:1.25;
      padding:10px 6px;
      min-height:220px;
      border-right:1px dashed rgba(0,0,0,.12);
    }

    .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      justify-content:flex-start;
      min-width:220px;
      flex:1;
      padding-top:6px;
    }

    .link{
      display:inline-block;
      color:var(--indigo);
      text-decoration:underline;
      text-underline-offset:3px;
      word-break:break-all;
      font-size:15px;
    }

    .small{
      color:#444;
      font-size:12px;
      line-height:1.6;
    }

    .err{
      margin-top:10px;
      white-space:pre-wrap;
      color:var(--seal);
      font-size:13px;
      display:none;
    }

    .footer{
      margin-top:16px;
      padding:14px 16px;
      border:1px dashed #cbbd9f;
      border-radius:16px;
      background:rgba(255,255,255,.45);
    }
    .footer h2{
      margin:0 0 8px;
      font-family:"Yuji Syuku","Yuji Boku",serif;
      font-size:18px;
      letter-spacing:.08em;
    }
    .footlink{
      color:var(--indigo);
      text-decoration:underline;
      text-underline-offset:3px;
      word-break:break-all;
      font-size:13px;
    }

    /* スマホ時は縦書きを少し小さく */
    @media (max-width:520px){
      .title{font-size:34px}
      .vertical{font-size:24px; min-height:190px;}
      .actions{min-width:unset}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 class="title">今日の推しジョッキー</h1>
        <p class="hint">「勝負！」を押すと、UMAJO掲載ジョッキーが一名選ばれます。</p>
      </div>
    </div>

    <div class="shrine">
      <div class="seal">推</div>

      <div class="btnrow">
        <!-- idは維持（壊れないため） -->
        <button id="drawBtn" class="btn main" type="button">勝負！</button>
        <button id="shareBtn" class="btn share" type="button" disabled>シェア</button>
      </div>

      <!-- 結果表示（id維持） -->
      <div class="omikuji" id="result">
        <div class="omikujiInner">
          <div class="vertical" id="name">（表示）</div>

          <div class="actions">
            <a id="profileLink" class="link" href="#" target="_blank" rel="noopener noreferrer">プロフィールを見る</a>
            <div class="small">
              ※リンク先はUMAJOの個別プロフィールです。<br>
              ※ページが開けない場合は、時間をおいて再度お試しください。
            </div>

            <!-- 以前のmetaは非表示のまま（候補数表示を出さない） -->
            <div id="meta" style="display:none;"></div>

            <div class="err" id="err"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- おすすめサイト（最下部） -->
    <div class="footer">
      <h2>おすすめサイト</h2>
      <a class="footlink"
         href="https://c-lemaire.co.jp/?srsltid=AfmBOop6TBukVoj2Y2Cs9SYRuY_8TsMUwtuXH3sUJPnIAXSxN-VKYrgq"
         target="_blank" rel="noopener noreferrer">
        https://c-lemaire.co.jp/
      </a>
    </div>
  </div>

  <script>
    // ★重要：idを変えないことで、ここが壊れにくい構造です
    const drawBtn  = document.getElementById("drawBtn");
    const shareBtn = document.getElementById("shareBtn");
    const resultEl = document.getElementById("result");
    const nameEl   = document.getElementById("name");
    const linkEl   = document.getElementById("profileLink");
    const errEl    = document.getElementById("err");

    let lastPicked = null;

    function showError(msg){
      resultEl.style.display = "block";
      errEl.style.display = "block";
      errEl.textContent = msg;
    }
    function clearError(){
      errEl.style.display = "none";
      errEl.textContent = "";
    }

    async function draw(){
      drawBtn.disabled = true;
      shareBtn.disabled = true;
      drawBtn.textContent = "神託中…";
      clearError();

      try{
        const res = await fetch("/api/oshi-jockey", { cache: "no-store" });

        // JSON以外が返っても落ちないように、まずテキストで受け取る
        const text = await res.text();
        let data;
        try{
          data = JSON.parse(text);
        }catch{
          throw new Error("APIの応答がJSONではありませんでした。時間をおいて再度お試しください。");
        }

        if(!res.ok || data.error){
          throw new Error(data.message || `API error: ${res.status}`);
        }

        const picked = data.picked || {};
        const name = picked.name || "(ジョッキー)";
        const profileUrl = picked.profileUrl;

        if(!profileUrl){
          throw new Error("APIの返却に profileUrl がありません。");
        }

        // 縦書き表示：そのまま入れてOK
        lastPicked = { name, profileUrl };

        nameEl.textContent = name;

        linkEl.href = profileUrl;
        linkEl.target = "_blank";
        linkEl.rel = "noopener noreferrer";

        resultEl.style.display = "block";
        shareBtn.disabled = false;

      }catch(e){
        console.error(e);
        lastPicked = null;
        showError("取得に失敗しました。\n\n" + String(e.message || e));
      }finally{
        drawBtn.disabled = false;
        drawBtn.textContent = "勝負！";
      }
    }

    async function share(){
      if(!lastPicked) return;

      const text = `今日の推しジョッキーは「${lastPicked.name}」！`;
      const url  = lastPicked.profileUrl;

      if(navigator.share){
        try{
          await navigator.share({ title:"今日の推しジョッキー", text, url });
          return;
        }catch(_){}
      }

      const xUrl = `https://x.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
      window.open(xUrl, "_blank", "noopener,noreferrer");
    }

    drawBtn.addEventListener("click", draw);
    shareBtn.addEventListener("click", share);
  </script>
</body>
</html>
